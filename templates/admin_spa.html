<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Vehicle Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .vehicle-card {
            transition: transform 0.2s;
        }
        .vehicle-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .vehicle-image {
            height: 200px;
            object-fit: cover;
        }
        .price-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }
        .status-badge {
            position: absolute;
            top: 10px;
            left: 10px;
        }
        .modal-xl {
            max-width: 90%;
        }
        .form-step {
            display: none;
        }
        .form-step.active {
            display: block;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .step::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            right: -50%;
            height: 2px;
            background: #dee2e6;
            z-index: 1;
        }
        .step:last-child::before {
            display: none;
        }
        .step.completed::before {
            background: #28a745;
        }
        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #dee2e6;
            color: #6c757d;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
            z-index: 2;
        }
        .step.completed .step-circle {
            background: #28a745;
            color: white;
        }
        .step.active .step-circle {
            background: #007bff;
            color: white;
        }
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            margin: 5px;
            border-radius: 8px;
        }
        .loading-spinner {
            display: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-car me-2"></i>Admin Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">Welcome, Admin</span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Header with Stats and Add Button -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h2><i class="fas fa-cars me-2"></i>Vehicle Management</h2>
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h5 id="totalVehicles">0</h5>
                                <small>Total Vehicles</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h5 id="availableVehicles">0</h5>
                                <small>Available</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body">
                                <h5 id="soldVehicles">0</h5>
                                <small>Sold</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h5 id="totalValue">₹0</h5>
                                <small>Total Value</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-success btn-lg" onclick="openAddModal()">
                    <i class="fas fa-plus me-2"></i>Add New Vehicle
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="row mb-4">
            <div class="col-md-3">
                <select class="form-select" id="categoryFilter" onchange="applyFilters()">
                    <option value="">All Categories</option>
                    <option value="Cars">Cars</option>
                    <option value="Trucks">Trucks</option>
                    <option value="Commercial Vehicles">Commercial Vehicles</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="statusFilter" onchange="applyFilters()">
                    <option value="">All Status</option>
                    <option value="available">Available</option>
                    <option value="sold">Sold</option>
                </select>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" id="searchInput" placeholder="Search vehicles..." oninput="applyFilters()">
                    <button class="btn btn-outline-secondary" type="button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="text-center loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading vehicles...</p>
        </div>

        <!-- Vehicles Grid -->
        <div class="row" id="vehiclesContainer">
            <!-- Vehicles will be loaded here via JavaScript -->
        </div>
    </div>

    <!-- Add/Edit Vehicle Modal -->
    <div class="modal fade" id="vehicleModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">
                        <i class="fas fa-plus me-2"></i>Add New Vehicle
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Step Indicator -->
                    <div class="step-indicator">
                        <div class="step active" data-step="1">
                            <div class="step-circle">1</div>
                            <small class="d-block mt-1">Basic Info</small>
                        </div>
                        <div class="step" data-step="2">
                            <div class="step-circle">2</div>
                            <small class="d-block mt-1">Details</small>
                        </div>
                        <div class="step" data-step="3">
                            <div class="step-circle">3</div>
                            <small class="d-block mt-1">Engine & Performance</small>
                        </div>
                        <div class="step" data-step="4">
                            <div class="step-circle">4</div>
                            <small class="d-block mt-1">Ownership & History</small>
                        </div>
                        <div class="step" data-step="5">
                            <div class="step-circle">5</div>
                            <small class="d-block mt-1">Features & Condition</small>
                        </div>
                        <div class="step" data-step="6">
                            <div class="step-circle">6</div>
                            <small class="d-block mt-1">Images</small>
                        </div>
                    </div>

                    <form id="vehicleForm">
                        <input type="hidden" id="vehicleId" name="vehicle_id">
                        
                        <!-- Step 1: Basic Information -->
                        <div class="form-step active" data-step="1">
                            <h6 class="border-bottom pb-2 mb-3">Basic Information</h6>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Vehicle Title *</label>
                                    <input type="text" class="form-control" id="title" name="title" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Category *</label>
                                    <select class="form-select" id="category" name="category" required>
                                        <option value="">Select Category</option>
                                        <option value="Cars">Cars</option>
                                        <option value="Trucks">Trucks</option>
                                        <option value="Commercial Vehicles">Commercial Vehicles</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Make *</label>
                                    <input type="text" class="form-control" id="make" name="make" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Model *</label>
                                    <input type="text" class="form-control" id="model" name="model" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Year *</label>
                                    <input type="number" class="form-control" id="year" name="year" min="1980" max="2025" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Price (₹) *</label>
                                    <input type="number" class="form-control" id="price" name="price" min="0" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Mileage (km)</label>
                                    <input type="number" class="form-control" id="mileage" name="mileage" min="0">
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Contact Details -->
                        <div class="form-step" data-step="2">
                            <h6 class="border-bottom pb-2 mb-3">Contact Information</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Contact Name *</label>
                                    <input type="text" class="form-control" id="contact_name" name="contact_name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Contact Phone *</label>
                                    <input type="tel" class="form-control" id="contact_phone" name="contact_phone" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Contact Email</label>
                                    <input type="email" class="form-control" id="contact_email" name="contact_email">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="status" name="status">
                                        <option value="available">Available</option>
                                        <option value="sold">Sold</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Engine & Performance -->
                        <div class="form-step" data-step="3">
                            <h6 class="border-bottom pb-2 mb-3">Engine & Performance</h6>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Fuel Type</label>
                                    <select class="form-select" id="fuel_type" name="fuel_type">
                                        <option value="">Select Fuel Type</option>
                                        <option value="Gasoline">Gasoline</option>
                                        <option value="Diesel">Diesel</option>
                                        <option value="Electric">Electric</option>
                                        <option value="Hybrid">Hybrid</option>
                                        <option value="CNG">CNG</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Transmission</label>
                                    <select class="form-select" id="transmission" name="transmission">
                                        <option value="">Select Transmission</option>
                                        <option value="Manual">Manual</option>
                                        <option value="Automatic">Automatic</option>
                                        <option value="CVT">CVT</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Engine Size</label>
                                    <input type="text" class="form-control" id="engine_size" name="engine_size" placeholder="e.g., 2.0L">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Horsepower</label>
                                    <input type="number" class="form-control" id="horsepower" name="horsepower" min="0">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Fuel Economy</label>
                                    <input type="text" class="form-control" id="fuel_economy" name="fuel_economy" placeholder="e.g., 15 kmpl">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Drivetrain</label>
                                    <select class="form-select" id="drivetrain" name="drivetrain">
                                        <option value="">Select Drivetrain</option>
                                        <option value="FWD">FWD</option>
                                        <option value="RWD">RWD</option>
                                        <option value="AWD">AWD</option>
                                        <option value="4WD">4WD</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Ownership & History -->
                        <div class="form-step" data-step="4">
                            <h6 class="border-bottom pb-2 mb-3">Ownership & History</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Number of Owners</label>
                                    <input type="number" class="form-control" id="number_of_owners" name="number_of_owners" min="1">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Odometer Reading</label>
                                    <input type="number" class="form-control" id="odometer_reading" name="odometer_reading" min="0">
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Accident History</label>
                                    <textarea class="form-control" id="accident_history" name="accident_history" rows="2"></textarea>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Service Records</label>
                                    <textarea class="form-control" id="service_records" name="service_records" rows="2"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Step 5: Features & Condition -->
                        <div class="form-step" data-step="5">
                            <h6 class="border-bottom pb-2 mb-3">Features & Condition</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Exterior Color</label>
                                    <input type="text" class="form-control" id="exterior_color" name="exterior_color">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Interior Color</label>
                                    <input type="text" class="form-control" id="interior_color" name="interior_color">
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Features</label>
                                    <textarea class="form-control" id="features" name="features" rows="2" placeholder="List key features separated by commas"></textarea>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Condition Rating</label>
                                    <select class="form-select" id="condition_rating" name="condition_rating">
                                        <option value="">Select Condition</option>
                                        <option value="Excellent">Excellent</option>
                                        <option value="Very Good">Very Good</option>
                                        <option value="Good">Good</option>
                                        <option value="Fair">Fair</option>
                                        <option value="Poor">Poor</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Warranty Information</label>
                                    <input type="text" class="form-control" id="warranty_info" name="warranty_info">
                                </div>
                            </div>
                        </div>

                        <!-- Step 6: Images -->
                        <div class="form-step" data-step="6">
                            <h6 class="border-bottom pb-2 mb-3">Vehicle Images</h6>
                            <div class="mb-3">
                                <label class="form-label">Upload Images (Max 6 images)</label>
                                <input type="file" class="form-control" id="images" name="images" multiple accept="image/*">
                                <div class="form-text">Supported formats: JPG, PNG, GIF. Max size: 16MB each.</div>
                            </div>
                            <div id="imagePreview" class="d-flex flex-wrap"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="prevBtn" onclick="previousStep()" style="display:none;">Previous</button>
                    <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">Next</button>
                    <button type="button" class="btn btn-success" id="saveBtn" onclick="saveVehicle()" style="display:none;">Save Vehicle</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this vehicle? This action cannot be undone.</p>
                    <div id="deleteVehicleInfo"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert">
            <div class="toast-body">
                <span id="toastMessage"></span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let vehicles = [];
        let filteredVehicles = [];
        let currentStep = 1;
        let isEditMode = false;
        let editVehicleId = null;
        let deleteVehicleId = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadVehicles();
            setupImagePreview();
        });

        // Load all vehicles from the API
        async function loadVehicles() {
            try {
                showLoading(true);
                const response = await fetch('/api/vehicles');
                const data = await response.json();
                
                if (data.success) {
                    vehicles = data.vehicles;
                    filteredVehicles = [...vehicles];
                    displayVehicles();
                    updateStats();
                } else {
                    showToast('Failed to load vehicles', 'error');
                }
            } catch (error) {
                console.error('Error loading vehicles:', error);
                showToast('Error loading vehicles', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Display vehicles in the grid
        function displayVehicles() {
            const container = document.getElementById('vehiclesContainer');
            
            if (filteredVehicles.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-car fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No vehicles found</h5>
                        <p class="text-muted">Add your first vehicle to get started</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredVehicles.map(vehicle => `
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card vehicle-card h-100">
                        <div class="position-relative">
                            <img src="/static/uploads/${vehicle.images && vehicle.images[0] ? vehicle.images[0] : 'placeholder.jpg'}" 
                                 class="card-img-top vehicle-image" 
                                 alt="${vehicle.title}"
                                 onerror="this.src='/static/placeholder.jpg'">
                            <span class="price-badge">₹${formatPrice(vehicle.price)}</span>
                            <span class="status-badge badge bg-${vehicle.status === 'available' ? 'success' : 'warning'}">
                                ${vehicle.status.toUpperCase()}
                            </span>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${vehicle.title}</h5>
                            <p class="card-text text-muted small mb-2">
                                ${vehicle.year} • ${vehicle.make} ${vehicle.model} • ${vehicle.mileage ? vehicle.mileage + ' km' : 'N/A'}
                            </p>
                            <p class="card-text">${truncateText(vehicle.description || '', 100)}</p>
                            <div class="mt-auto">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-sm flex-fill" onclick="editVehicle('${vehicle.id}')">
                                        <i class="fas fa-edit me-1"></i>Edit
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteVehicle('${vehicle.id}')">
                                        <i class="fas fa-trash me-1"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update statistics
        function updateStats() {
            const total = vehicles.length;
            const available = vehicles.filter(v => v.status === 'available').length;
            const sold = vehicles.filter(v => v.status === 'sold').length;
            const totalValue = vehicles.reduce((sum, v) => sum + (parseFloat(v.price) || 0), 0);

            document.getElementById('totalVehicles').textContent = total;
            document.getElementById('availableVehicles').textContent = available;
            document.getElementById('soldVehicles').textContent = sold;
            document.getElementById('totalValue').textContent = '₹' + formatPrice(totalValue);
        }

        // Apply filters
        function applyFilters() {
            const category = document.getElementById('categoryFilter').value;
            const status = document.getElementById('statusFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            filteredVehicles = vehicles.filter(vehicle => {
                const matchesCategory = !category || vehicle.category === category;
                const matchesStatus = !status || vehicle.status === status;
                const matchesSearch = !search || 
                    vehicle.title.toLowerCase().includes(search) ||
                    vehicle.make.toLowerCase().includes(search) ||
                    vehicle.model.toLowerCase().includes(search) ||
                    vehicle.description?.toLowerCase().includes(search);

                return matchesCategory && matchesStatus && matchesSearch;
            });

            displayVehicles();
        }

        // Open add vehicle modal
        function openAddModal() {
            isEditMode = false;
            editVehicleId = null;
            currentStep = 1;
            
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus me-2"></i>Add New Vehicle';
            document.getElementById('vehicleForm').reset();
            document.getElementById('vehicleId').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            
            updateStepDisplay();
            new bootstrap.Modal(document.getElementById('vehicleModal')).show();
        }

        // Edit vehicle
        async function editVehicle(vehicleId) {
            try {
                const response = await fetch(`/admin/vehicle/${vehicleId}`);
                const data = await response.json();
                
                if (data.success) {
                    isEditMode = true;
                    editVehicleId = vehicleId;
                    currentStep = 1;
                    
                    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Vehicle';
                    
                    // Populate form with vehicle data
                    const vehicle = data.vehicle;
                    Object.keys(vehicle).forEach(key => {
                        const element = document.getElementById(key);
                        if (element && key !== 'images') {
                            element.value = vehicle[key] || '';
                        }
                    });
                    
                    // Handle image preview
                    if (vehicle.images && vehicle.images.length > 0) {
                        const preview = document.getElementById('imagePreview');
                        preview.innerHTML = vehicle.images.map(img => 
                            `<img src="/static/uploads/${img}" class="image-preview" alt="Vehicle image">`
                        ).join('');
                    }
                    
                    updateStepDisplay();
                    new bootstrap.Modal(document.getElementById('vehicleModal')).show();
                    showToast('Vehicle data loaded for editing', 'success');
                } else {
                    showToast('Failed to load vehicle data', 'error');
                }
            } catch (error) {
                console.error('Error loading vehicle:', error);
                showToast('Error loading vehicle data', 'error');
            }
        }

        // Delete vehicle
        function deleteVehicle(vehicleId) {
            deleteVehicleId = vehicleId;
            const vehicle = vehicles.find(v => v.id === vehicleId);
            
            if (vehicle) {
                document.getElementById('deleteVehicleInfo').innerHTML = `
                    <div class="alert alert-warning">
                        <strong>${vehicle.title}</strong><br>
                        ${vehicle.year} ${vehicle.make} ${vehicle.model}<br>
                        Price: ₹${formatPrice(vehicle.price)}
                    </div>
                `;
                new bootstrap.Modal(document.getElementById('deleteModal')).show();
            }
        }

        // Confirm delete
        async function confirmDelete() {
            if (!deleteVehicleId) return;

            try {
                const response = await fetch(`/admin/delete_vehicle/${deleteVehicleId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    vehicles = vehicles.filter(v => v.id !== deleteVehicleId);
                    filteredVehicles = filteredVehicles.filter(v => v.id !== deleteVehicleId);
                    displayVehicles();
                    updateStats();
                    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                    showToast('Vehicle deleted successfully', 'success');
                } else {
                    showToast('Failed to delete vehicle', 'error');
                }
            } catch (error) {
                console.error('Error deleting vehicle:', error);
                showToast('Error deleting vehicle', 'error');
            }

            deleteVehicleId = null;
        }

        // Step navigation
        function nextStep() {
            if (currentStep < 6) {
                currentStep++;
                updateStepDisplay();
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            }
        }

        // Update step display
        function updateStepDisplay() {
            // Update step indicators
            document.querySelectorAll('.step').forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed');
                
                if (stepNumber < currentStep) {
                    step.classList.add('completed');
                } else if (stepNumber === currentStep) {
                    step.classList.add('active');
                }
            });

            // Show/hide form steps
            document.querySelectorAll('.form-step').forEach(step => {
                step.classList.remove('active');
            });
            document.querySelector(`.form-step[data-step="${currentStep}"]`).classList.add('active');

            // Update navigation buttons
            document.getElementById('prevBtn').style.display = currentStep > 1 ? 'block' : 'none';
            document.getElementById('nextBtn').style.display = currentStep < 6 ? 'block' : 'none';
            document.getElementById('saveBtn').style.display = currentStep === 6 ? 'block' : 'none';
        }

        // Save vehicle
        async function saveVehicle() {
            try {
                const formData = new FormData(document.getElementById('vehicleForm'));
                
                // Add files
                const fileInput = document.getElementById('images');
                if (fileInput.files.length > 0) {
                    for (let file of fileInput.files) {
                        formData.append('images', file);
                    }
                }

                const url = isEditMode ? `/admin/edit_vehicle/${editVehicleId}` : '/admin/add_vehicle';
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('vehicleModal')).hide();
                    showToast(isEditMode ? 'Vehicle updated successfully' : 'Vehicle added successfully', 'success');
                    loadVehicles(); // Reload vehicles
                } else {
                    if (data.errors) {
                        const errorMessages = Object.values(data.errors).flat().join(', ');
                        showToast('Validation errors: ' + errorMessages, 'error');
                    } else {
                        showToast(data.message || 'Failed to save vehicle', 'error');
                    }
                }
            } catch (error) {
                console.error('Error saving vehicle:', error);
                showToast('Error saving vehicle', 'error');
            }
        }

        // Setup image preview
        function setupImagePreview() {
            document.getElementById('images').addEventListener('change', function(e) {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = '';

                Array.from(e.target.files).slice(0, 6).forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'image-preview';
                            preview.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            });
        }

        // Utility functions
        function formatPrice(price) {
            return new Intl.NumberFormat('en-IN').format(price);
        }

        function truncateText(text, length) {
            return text.length > length ? text.substring(0, length) + '...' : text;
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = `toast bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} text-white`;
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/admin/logout';
            }
        }
    </script>
</body>
</html>
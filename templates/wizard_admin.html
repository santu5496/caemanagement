{% extends "base.html" %}

{% block title %}Vehicle Management - AutoMarket{% endblock %}

{% block content %}
<style>
/* Step-by-Step Wizard Styling */
.wizard-container {
    max-width: 800px;
    margin: 0 auto;
}

.step-indicators {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2rem;
    position: relative;
}

.step-indicators::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 10%;
    right: 10%;
    height: 2px;
    background: #e9ecef;
    z-index: 1;
}

.step-item {
    text-align: center;
    position: relative;
    z-index: 2;
    flex: 1;
    cursor: pointer;
    transition: all 0.3s ease;
}

.step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 0.5rem;
    transition: all 0.3s ease;
    font-size: 1.1rem;
}

.step-item.active .step-circle {
    background: #007bff;
    color: white;
    box-shadow: 0 0 20px rgba(0, 123, 255, 0.3);
}

.step-item.completed .step-circle {
    background: #28a745;
    color: white;
}

.step-label {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 500;
}

.step-item.active .step-label {
    color: #007bff;
    font-weight: 600;
}

.step-item.completed .step-label {
    color: #28a745;
}

.step-content {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
    min-height: 400px;
}

.step-pane {
    display: none;
}

.step-pane.active {
    display: block;
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.step-header {
    text-align: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #f8f9fa;
}

.step-title {
    color: #007bff;
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.step-description {
    color: #6c757d;
    font-size: 1rem;
}

.wizard-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
}

.btn-wizard {
    min-width: 120px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    border-radius: 8px;
}

.form-control, .form-select {
    color: #212529 !important;
    background-color: #ffffff !important;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 0.75rem;
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.15);
    color: #212529 !important;
    background-color: #ffffff !important;
}

.form-label {
    color: #212529 !important;
    font-weight: 600 !important;
    margin-bottom: 0.5rem;
}

.required-indicator {
    color: #dc3545;
    margin-left: 3px;
}

.field-help {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.progress-bar-custom {
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 2rem;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #007bff, #0056b3);
    transition: width 0.3s ease;
    border-radius: 3px;
}

.summary-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e9ecef;
}

.summary-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.image-upload-area {
    border: 2px dashed #007bff;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    background: #f8f9fa;
    transition: all 0.3s ease;
}

.image-upload-area:hover {
    background: #e3f2fd;
    border-color: #0056b3;
}

.image-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.image-preview-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.image-preview-item img {
    width: 100%;
    height: 120px;
    object-fit: cover;
}

.image-remove-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(220, 53, 69, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
}

.navigation-info {
    color: #6c757d;
    font-size: 0.875rem;
    text-align: center;
    margin-top: 1rem;
}

/* Image Slot specific styling */
.image-upload-slot {
    border: 2px dashed #007bff;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,123,255,0.1);
    min-height: 200px;
    cursor: pointer;
}

.image-upload-slot:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,123,255,0.2);
}

.slot-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
}

.slot-content i {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.slot-content p {
    margin-bottom: 0.25rem;
    font-weight: bold;
}

.slot-content small {
    font-size: 0.8rem;
}

.image-upload-slot img {
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

@media (max-width: 768px) {
    .step-indicators {
        flex-wrap: wrap;
        gap: 1rem;
    }

    .step-item {
        flex: 1 1 calc(33.333% - 1rem);
        min-width: 100px;
    }

    .wizard-navigation {
        flex-direction: column;
        gap: 1rem;
    }

    .step-content {
        padding: 1.5rem;
    }
}

/* Dashboard styling */
.dashboard-header {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border-radius: 12px;
    margin-bottom: 2rem;
}

.stats-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    border: none;
    transition: transform 0.3s ease;
}

.stats-card:hover {
    transform: translateY(-5px);
}

.vehicle-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}
</style>

<div class="container-fluid py-4">
    <!-- Dashboard Header -->
    <div class="dashboard-header p-4 mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-tachometer-alt me-2"></i>Vehicle Management Dashboard
                </h1>
                <p class="mb-0 opacity-75">Add and manage your vehicle inventory with our step-by-step wizard</p>
            </div>
            <div class="col-md-4 text-md-end">
                <button type="button" class="btn btn-light btn-lg" onclick="openWizard()">
                    <i class="fas fa-plus me-2"></i>Add New Vehicle
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-car fa-2x text-primary mb-2"></i>
                    <h3 class="text-primary mb-1">{{ vehicles|length }}</h3>
                    <h6 class="text-muted mb-0">Total Vehicles</h6>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                    <h3 class="text-success mb-1">{{ vehicles|selectattr("status", "equalto", "available")|list|length }}</h3>
                    <h6 class="text-muted mb-0">Available</h6>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-handshake fa-2x text-warning mb-2"></i>
                    <h3 class="text-warning mb-1">{{ vehicles|selectattr("status", "equalto", "sold")|list|length }}</h3>
                    <h6 class="text-muted mb-0">Sold</h6>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-dollar-sign fa-2x text-info mb-2"></i>
                    <h3 class="text-info mb-1">${{ "{:,.0f}".format((vehicles|selectattr("status", "equalto", "available")|map(attribute="price")|sum)/1000) }}K</h3>
                    <h6 class="text-muted mb-0">Inventory Value</h6>
                </div>
            </div>
        </div>
    </div>

    <!-- Vehicles Table -->
    <div class="vehicle-table">
        <div class="card-header bg-white border-bottom">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2 text-primary"></i>Vehicle Inventory
                    </h5>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search vehicles..." id="searchInput">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover mb-0" id="vehiclesTable">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Vehicle Details</th>
                        <th>Price</th>
                        <th>Mileage</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vehicle in vehicles %}
                    <tr>
                        <td>
                            {% if vehicle.images_list %}
                                <img src="{{ url_for('static', filename='uploads/' + vehicle.images_list[0]) }}" 
                                     class="rounded" style="width: 60px; height: 45px; object-fit: cover;" 
                                     alt="{{ vehicle.title }}">
                            {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center text-muted" 
                                     style="width: 60px; height: 45px;">
                                    <i class="fas fa-car"></i>
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <div>
                                <h6 class="mb-1">{{ vehicle.title }}</h6>
                                <small class="text-muted">{{ vehicle.year }} â€¢ {{ vehicle.make }} {{ vehicle.model }}</small>
                            </div>
                        </td>
                        <td>
                            <strong class="text-success">â‚¹{{ "{:,.0f}".format(vehicle.price) }}</strong>
                        </td>
                        <td>
                            {{ "{:,}".format(vehicle.mileage) }} mi
                        </td>
                        <td>
                            {% if vehicle.status == 'available' %}
                                <span class="badge bg-success">Available</span>
                            {% else %}
                                <span class="badge bg-secondary">Sold</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="viewVehicle('{{ vehicle.id }}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-outline-warning" onclick="editVehicle('{{ vehicle.id }}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="deleteVehicle('{{ vehicle.id }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Step-by-Step Vehicle Wizard Modal -->
<div class="modal fade" id="vehicleWizard" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">
                    <i class="fas fa-magic me-2"></i>Add Vehicle - Step by Step
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body p-0">
                <div class="wizard-container p-4">
                    <!-- Progress Bar -->
                    <div class="progress-bar-custom">
                        <div class="progress-fill" id="progressFill" style="width: 16.67%;"></div>
                    </div>

                    <!-- Step Indicators -->
                    <div class="step-indicators">
                        <div class="step-item active" data-step="1">
                            <div class="step-circle">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="step-label">Basic Info</div>
                        </div>
                        <div class="step-item" data-step="2">
                            <div class="step-circle">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div class="step-label">Engine</div>
                        </div>
                        <div class="step-item" data-step="3">
                            <div class="step-circle">
                                <i class="fas fa-history"></i>
                            </div>
                            <div class="step-label">History</div>
                        </div>
                        <div class="step-item" data-step="4">
                            <div class="step-circle">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="step-label">Documents</div>
                        </div>
                        <div class="step-item" data-step="5">
                            <div class="step-circle">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="step-label">Features</div>
                        </div>
                        <div class="step-item" data-step="6">
                            <div class="step-circle">
                                <i class="fas fa-camera"></i>
                            </div>
                            <div class="step-label">Photos</div>
                        </div>
                    </div>

                    <form id="vehicleWizardForm" method="POST" enctype="multipart/form-data" action="/admin/add_vehicle">

                        <!-- Step 1: Basic Information -->
                        <div class="step-content">
                            <div class="step-pane active" id="step1">
                                <div class="step-header">
                                    <h3 class="step-title">
                                        <i class="fas fa-info-circle me-2 text-primary"></i>
                                        Step 1: Basic Vehicle Information
                                    </h3>
                                    <p class="step-description">
                                        Start by entering the essential details about your vehicle. 
                                        <strong>Required fields are marked with a red asterisk (*)</strong>
                                    </p>
                                    <div class="alert alert-info">
                                        <i class="fas fa-lightbulb me-2"></i>
                                        <strong>Tip:</strong> Make sure your vehicle title is descriptive and includes key features to attract buyers.
                                    </div>
                                </div>

                                <div class="row g-4">
                                    <div class="col-12">
                                        <label class="form-label">Vehicle Title<span class="required-indicator">*</span></label>
                                        {{ form.title(class="form-control form-control-lg", placeholder="e.g., 2020 Honda Civic LX - Excellent Condition", required=true) }}
                                        <div class="field-help">Create an attractive title that highlights key features</div>
                                        <div class="invalid-feedback"></div>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Category<span class="required-indicator">*</span></label>
                                        {{ form.category(class="form-select form-select-lg", required=true) }}
                                        <div class="invalid-feedback"></div>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Year<span class="required-indicator">*</span></label>
                                        {{ form.year(class="form-control", placeholder="e.g., 2020", required=true) }}
                                        <div class="invalid-feedback"></div>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Make<span class="required-indicator">*</span></label>
                                        {{ form.make(class="form-control", placeholder="e.g., Honda", required=true) }}
                                        <div class="invalid-feedback"></div>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Model<span class="required-indicator">*</span></label>
                                        {{ form.model(class="form-control", placeholder="e.g., Civic", required=true) }}
                                        <div class="invalid-feedback"></div>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="price" class="form-label">Price (â‚¹) *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">â‚¹</span>
                                            {{ form.price(class="form-control", id="price", placeholder="e.g., 1500000", min="1", step="1000", required=true, oninput="this.setCustomValidity(this.value <= 0 ? 'Price must be greater than 0' : '')") }}
                                        </div>
                                        <div class="invalid-feedback">Please enter a valid price greater than 0</div>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Mileage<span class="required-indicator">*</span></label>
                                        <div class="input-group input-group-lg">
                                            {{ form.mileage(class="form-control", placeholder="50000", required=true) }}
                                            <span class="input-group-text">miles</span>
                                        </div>
                                        <div class="invalid-feedback"></div>
                                    </div>

                                    <div class="col-12">
                                        <label class="form-label">Description</label>
                                        {{ form.description(class="form-control", rows="4", placeholder="Describe the vehicle's condition, features, and any important details...") }}
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: Engine & Performance -->
                            <div class="step-pane" id="step2">
                                <div class="step-header">
                                    <h3 class="step-title">
                                        <i class="fas fa-cogs me-2 text-primary"></i>
                                        Step 2: Engine & Performance
                                    </h3>
                                    <p class="step-description">
                                        Add technical specifications that help buyers understand your vehicle's performance.
                                        <em>All fields in this step are optional.</em>
                                    </p>
                                    <div class="alert alert-success">
                                        <i class="fas fa-check-circle me-2"></i>
                                        <strong>Great!</strong> You've completed the basic information. Now let's add technical details.
                                    </div>
                                </div>

                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <label class="form-label">Fuel Type</label>
                                        {{ form.fuel_type(class="form-select") }}
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Transmission</label>
                                        {{ form.transmission(class="form-select") }}
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Engine Size</label>
                                        {{ form.engine_size(class="form-control", placeholder="e.g., 2.0L") }}
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Horsepower</label>
                                        {{ form.horsepower(class="form-control", placeholder="e.g., 180") }}
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Drivetrain</label>
                                        {{ form.drivetrain(class="form-select") }}
                                    </div>

                                    <div class="col-12">
                                        <label class="form-label">Fuel Economy</label>
                                        {{ form.fuel_economy(class="form-control", placeholder="e.g., 25 city / 32 highway mpg") }}
                                    </div>
                                </div>
                            </div>

                            <!-- Step 3: Ownership & History -->
                            <div class="step-pane" id="step3">
                                <div class="step-header">
                                    <h3 class="step-title">Ownership & History</h3>
                                    <p class="step-description">Previous ownership and vehicle history information</p>
                                </div>

                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <label class="form-label">Number of Previous Owners</label>
                                        {{ form.number_of_owners(class="form-control", placeholder="e.g., 1") }}
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Odometer Reading</label>
                                        {{ form.odometer_reading(class="form-control", placeholder="Current mileage") }}
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Previous Owner Name</label>
                                        {{ form.previous_owner_name(class="form-control", placeholder="Owner name") }}
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Previous Owner Phone</label>
                                        {{ form.previous_owner_phone(class="form-control", placeholder="(555) 123-4567") }}
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Previous Owner Email</label>
                                        {{ form.previous_owner_email(class="form-control", placeholder="owner@email.com") }}
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Accident History</label>
                                        {{ form.accident_history(class="form-control", rows="3", placeholder="Any accident history or damage reports...") }}
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Service Records</label>
                                        {{ form.service_records(class="form-control", rows="3", placeholder="Maintenance and service records...") }}
                                    </div>
                                </div>
                            </div>

                            <!-- Step 4: Insurance & Documentation -->
                            <div class="step-pane" id="step4">
                                <div class="step-header">
                                    <h3 class="step-title">Insurance & Documentation</h3>
                                    <p class="step-description">Legal documents and insurance information</p>
                                </div>

                                <div class="row g-4">
                                    <div class="col-md-4">
                                        <label class="form-label">Insurance Company</label>
                                        {{ form.insurance_company(class="form-control", placeholder="e.g., State Farm") }}
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Policy Number</label>
                                        {{ form.insurance_policy_number(class="form-control", placeholder="Policy number") }}
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Insurance Expiry</label>
                                        {{ form.insurance_expiry(class="form-control", placeholder="MM/DD/YYYY") }}
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Registration Number</label>
                                        {{ form.registration_number(class="form-control", placeholder="Registration number") }}
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">VIN Number</label>
                                        {{ form.vin_number(class="form-control", placeholder="17-character VIN", maxlength="17") }}
                                        <div class="field-help">Vehicle Identification Number (exactly 17 characters)</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 5: Features & Condition -->
                            <div class="step-pane" id="step5">
                                <div class="step-header">
                                    <h3 class="step-title">Features & Condition</h3>
                                    <p class="step-description">Vehicle features, colors, and condition details</p>
                                </div>

                                <div class="row g-4">
                                    <div class="col-md-4">
                                        <label class="form-label">Exterior Color</label>
                                        {{ form.exterior_color(class="form-control", placeholder="e.g., Blue") }}
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Interior Color</label>
                                        {{ form.interior_color(class="form-control", placeholder="e.g., Black") }}
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Condition Rating</label>
                                        {{ form.condition_rating(class="form-select") }}
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Features</label>
                                        {{ form.features(class="form-control", rows="3", placeholder="List features separated by commas (e.g., Sunroof, Leather seats, Navigation...)") }}
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Warranty Information</label>
                                        {{ form.warranty_info(class="form-control", rows="3", placeholder="Warranty information and coverage details...") }}
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Contact Name<span class="required-indicator">*</span></label>
                                        {{ form.contact_name(class="form-control", placeholder="Contact person", required=true) }}
                                        <div class="invalid-feedback"></div>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Contact Phone<span class="required-indicator">*</span></label>
                                        {{ form.contact_phone(class="form-control", placeholder="(555) 123-4567", required=true) }}
                                        <div class="invalid-feedback"></div>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Contact Email</label>
                                        {{ form.contact_email(class="form-control", placeholder="contact@email.com") }}
                                    </div>
                                </div>
                            </div>

                            <!-- Step 6: Photos & Finish -->
                            <div class="step-pane" id="step6">
                                <div class="step-header">
                                    <h3 class="step-title">Photos & Final Review</h3>
                                    <p class="step-description">Add photos and review your vehicle listing</p>
                                </div>

                                <!-- 6 Image Upload Slots -->
                                <div class="row g-4">
                                    {% for i in range(1, 7) %}
                                    <div class="col-md-4" id="image-slot-{{ i }}">
                                        <div class="image-upload-slot border rounded-3 p-4 text-center position-relative" 
                                             style="min-height: 200px; cursor: pointer; border: 2px dashed #007bff !important; 
                                                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                                                    transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,123,255,0.1);" 
                                             onclick="triggerImageUpload({{ i }})"
                                             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.2)';"
                                             onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 2px 8px rgba(0,123,255,0.1)';">
                                            <div class="slot-content d-flex flex-column align-items-center justify-content-center h-100">
                                                <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
                                                <p class="mb-1 fw-bold">Click to upload</p>
                                                <small class="text-muted">or drag and drop image here</small>
                                                <small class="d-block text-muted mt-1">Max 5MB â€¢ JPG, PNG, GIF</small>
                                            </div>
                                            <input type="file" id="image-input-{{ i }}" accept="image/*" style="display: none;" onchange="handleImageUpload({{ i }}, this)">
                                            <img id="image-preview-{{ i }}" class="img-fluid rounded-3 w-100 h-100" style="display: none; object-fit: cover; position: absolute; top: 0px; left: 0px;">
                                            <button type="button" class="image-remove-btn" onclick="event.stopPropagation(); removeImage({{ i }});" style="display: none;">X</button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>

                                <!-- Hidden field for form submission -->
                                {{ form.images(style="display: none;", multiple=True) }}

                                <div class="col-12">
                                    <div class="summary-section">
                                        <h6 class="mb-3"><i class="fas fa-clipboard-list me-2"></i>Vehicle Summary</h6>
                                        <div id="vehicleSummary">
                                            <!-- Summary will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation -->
                        <div class="wizard-navigation">
                            <button type="button" class="btn btn-secondary btn-wizard" id="prevBtn" onclick="changeStep(-1)" style="display: none;">
                                <i class="fas fa-arrow-left me-2"></i>Previous
                            </button>

                            <div class="navigation-info">
                                Step <span id="currentStepNum">1</span> of 6
                            </div>

                            <button type="button" class="btn btn-primary btn-wizard" id="nextBtn" onclick="changeStep(1)">
                                Next<i class="fas fa-arrow-right ms-2"></i>
                            </button>

                            <button type="button" class="btn btn-success btn-wizard btn-lg" id="submitBtn" style="display: none;" onclick="submitVehicleForm()">
                                <i class="fas fa-save me-2"></i>Save Vehicle
                            </button>

                            <button type="button" class="btn btn-info btn-wizard" onclick="testAlert()" style="display: none;" id="testBtn">
                                <i class="fas fa-bell me-2"></i>Test Alert
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentStep = 1;
const totalSteps = 6;

// Array to store image files
let uploadedImages = Array(6).fill(null);

function openWizard() {
    // Reset edit mode variables
    isEditMode = false;
    editVehicleId = null;
    
    // Reset modal title for new vehicle
    const modalTitle = document.getElementById('modalTitle');
    if (modalTitle) {
        modalTitle.innerHTML = '<i class="fas fa-magic me-2"></i>Add Vehicle - Step by Step';
    }
    
    // Clear previous form data if opening for the first time or if not editing
    document.getElementById('vehicleWizardForm').reset();
    uploadedImages.fill(null); // Clear stored images
    
    // Clear image previews
    for(let i = 1; i <= 6; i++) {
        const previewImage = document.getElementById(`image-preview-${i}`);
        const removeBtn = document.querySelector(`#image-slot-${i} .image-remove-btn`);
        const slotContent = document.querySelector(`#image-slot-${i} .slot-content`);
        
        if(previewImage) {
            previewImage.src = '';
            previewImage.style.display = 'none';
        }
        if(removeBtn) removeBtn.style.display = 'none';
        if(slotContent) slotContent.style.display = 'flex';
    }

    // Clear validation states
    document.querySelectorAll('.form-control, .form-select').forEach(field => {
        field.classList.remove('is-invalid');
        const feedback = field.nextElementSibling;
        if(feedback && feedback.classList.contains('invalid-feedback')) {
            feedback.style.display = 'none';
            feedback.textContent = '';
        }
    });

    currentStep = 1;
    updateWizardDisplay();
    new bootstrap.Modal(document.getElementById('vehicleWizard')).show();
}

function changeStep(direction) {
    if (direction === 1 && currentStep < totalSteps) {
        if (validateCurrentStep()) {
            currentStep++;
        }
    } else if (direction === -1 && currentStep > 1) {
        currentStep--;
    }

    updateWizardDisplay();
}

function updateWizardDisplay() {
    // Update progress bar with smooth animation
    const progress = (currentStep / totalSteps) * 100;
    document.getElementById('progressFill').style.width = progress + '%';

    // Update step indicators with icons
    document.querySelectorAll('.step-item').forEach((item, index) => {
        const stepNum = index + 1;
        const circle = item.querySelector('.step-circle');

        item.classList.toggle('active', stepNum === currentStep);
        item.classList.toggle('completed', stepNum < currentStep);

        // Update circle content
        if (stepNum < currentStep) {
            circle.innerHTML = '<i class="fas fa-check"></i>';
        } else if (stepNum === currentStep) {
            circle.innerHTML = `<i class="fas fa-${getStepIcon(stepNum)}"></i>`;
        } else {
            circle.innerHTML = stepNum;
        }
    });

    // Update step panes with smooth transition
    document.querySelectorAll('.step-pane').forEach((pane, index) => {
        if (index + 1 === currentStep) {
            pane.classList.add('active');
            // Focus on first input field
            setTimeout(() => {
                const firstInput = pane.querySelector('input, select, textarea');
                if (firstInput) firstInput.focus();
            }, 300);
        } else {
            pane.classList.remove('active');
        }
    });

    // Update navigation buttons
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const testBtn = document.getElementById('testBtn');

    prevBtn.style.display = currentStep === 1 ? 'none' : 'block';
    nextBtn.style.display = currentStep === totalSteps ? 'none' : 'block';
    submitBtn.style.display = currentStep === totalSteps ? 'block' : 'none';
    testBtn.style.display = currentStep === totalSteps ? 'block' : 'none';

    // Update button text based on next step
    if (currentStep < totalSteps) {
        const nextStepName = getStepName(currentStep + 1);
        nextBtn.innerHTML = `Next: ${nextStepName} <i class="fas fa-arrow-right ms-2"></i>`;
    } else {
        nextBtn.innerHTML = 'Next <i class="fas fa-arrow-right ms-2"></i>'; // Reset text for final step
    }

    // Update step counter
    document.getElementById('currentStepNum').textContent = currentStep;

    // Update summary on last step
    if (currentStep === totalSteps) {
        updateVehicleSummary();
        showAlert('ðŸŽ‰ Almost done! Please review your vehicle information and save.', 'info');
    }

    // Scroll to top of modal
    document.querySelector('.wizard-container').scrollTop = 0;
}

function getStepIcon(stepNum) {
    const icons = {
        1: 'info-circle',
        2: 'cogs', 
        3: 'history',
        4: 'shield-alt',
        5: 'star',
        6: 'camera'
    };
    return icons[stepNum] || 'circle';
}

function getStepName(stepNum) {
    const names = {
        1: 'Basic Info',
        2: 'Engine Details',
        3: 'History',
        4: 'Documents', 
        5: 'Features',
        6: 'Photos & Review'
    };
    return names[stepNum] || 'Next Step';
}

function validateCurrentStep() {
    const currentPane = document.getElementById(`step${currentStep}`);
    if (!currentPane) return true; // Should not happen, but safety check

    let isValid = true;
    let errorMessages = [];

    // Remove existing validation styles for the current pane
    currentPane.querySelectorAll('.is-invalid').forEach(field => {
        field.classList.remove('is-invalid');
    });
    currentPane.querySelectorAll('.invalid-feedback').forEach(feedback => {
        feedback.style.display = 'none';
        feedback.textContent = ''; // Clear error messages
    });

    // Validation logic per step
    if (currentStep === 1) {
        const requiredFields = [
            { name: 'title', label: 'Vehicle Title', minLength: 5 },
            { name: 'category', label: 'Category' },
            { name: 'make', label: 'Make' },
            { name: 'model', label: 'Model' },
            { name: 'year', label: 'Year' },
            { name: 'price', label: 'Price' },
            { name: 'mileage', label: 'Mileage' }
        ];

        requiredFields.forEach(fieldInfo => {
            const field = currentPane.querySelector(`[name="${fieldInfo.name}"]`);
            if (!field) return;

            // For editing mode, be more lenient with validation
            const fieldValue = field.value;
            const isEmpty = !fieldValue || (typeof fieldValue === 'string' && !fieldValue.trim());

            // Check if field is empty
            if (isEmpty) {
                field.classList.add('is-invalid');
                const feedback = field.nextElementSibling;
                if(feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.textContent = `${fieldInfo.label} is required`;
                    feedback.style.display = 'block';
                }
                errorMessages.push(`${fieldInfo.label} is required`);
                isValid = false;
            } else {
                // Field has value, check additional validations
                let fieldValid = true;
                let fieldError = '';

                // Title length validation - be more flexible for editing
                if (fieldInfo.name === 'title') {
                    const titleLength = fieldValue.toString().trim().length;
                    if (titleLength < 3) {
                        fieldValid = false;
                        fieldError = 'Vehicle Title must be at least 3 characters long';
                    } else if (titleLength > 200) {
                        fieldValid = false;
                        fieldError = 'Vehicle Title must be less than 200 characters';
                    }
                }

                // Year validation
                if (fieldInfo.name === 'year') {
                    const year = parseInt(field.value);
                    if (isNaN(year) || year < 1990 || year > 2025) {
                        fieldValid = false;
                        fieldError = 'Year must be between 1990 and 2025';
                    }
                }

                // Price validation
                if (fieldInfo.name === 'price') {
                    const price = parseFloat(field.value);
                    if (isNaN(price) || price <= 0) {
                        fieldValid = false;
                        fieldError = 'Price must be greater than 0';
                    }
                }

                // Mileage validation
                if (fieldInfo.name === 'mileage') {
                    const mileage = parseInt(field.value);
                    if (isNaN(mileage) || mileage < 0) {
                        fieldValid = false;
                        fieldError = 'Mileage cannot be negative';
                    }
                }

                if (!fieldValid) {
                    field.classList.add('is-invalid');
                    const feedback = field.nextElementSibling;
                    if(feedback && feedback.classList.contains('invalid-feedback')) {
                        feedback.textContent = fieldError;
                        feedback.style.display = 'block';
                    }
                    errorMessages.push(fieldError);
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                    const feedback = field.nextElementSibling;
                    if(feedback && feedback.classList.contains('invalid-feedback')) {
                        feedback.style.display = 'none';
                    }
                }
            }
        });
    } else if (currentStep === 5) {
         const requiredFields = [
            { name: 'contact_name', label: 'Contact Name' },
            { name: 'contact_phone', label: 'Contact Phone' }
        ];

        requiredFields.forEach(fieldInfo => {
            const field = currentPane.querySelector(`[name="${fieldInfo.name}"]`);
            if (!field) return;

            // Check if field is empty
            if (!field.value || !field.value.trim()) {
                field.classList.add('is-invalid');
                const feedback = field.nextElementSibling;
                if(feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.textContent = `${fieldInfo.label} is required`;
                    feedback.style.display = 'block';
                }
                errorMessages.push(`${fieldInfo.label} is required`);
                isValid = false;
            } else {
                // Field has value, check additional validations
                let fieldValid = true;
                let fieldError = '';

                // Phone validation - more flexible
                if (fieldInfo.name === 'contact_phone') {
                    const phoneRegex = /^[\d\s\-\(\)\+\.]{8,}$/; // Basic validation for phone numbers
                    if (!phoneRegex.test(field.value)) {
                        fieldValid = false;
                        fieldError = 'Please enter a valid phone number';
                    }
                }

                if (!fieldValid) {
                    field.classList.add('is-invalid');
                    const feedback = field.nextElementSibling;
                    if(feedback && feedback.classList.contains('invalid-feedback')) {
                        feedback.textContent = fieldError;
                        feedback.style.display = 'block';
                    }
                    errorMessages.push(fieldError);
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                    const feedback = field.nextElementSibling;
                    if(feedback && feedback.classList.contains('invalid-feedback')) {
                        feedback.style.display = 'none';
                    }
                }
            }
        });
    } else if (currentStep === 6) {
        // For editing, don't require new images if vehicle already has images
        const hasExistingImages = uploadedImages.some(img => typeof img === 'string' && img.length > 0);
        const hasNewImages = uploadedImages.some(img => img instanceof File);
        
        if (!hasExistingImages && !hasNewImages) {
            showAlert('Please upload at least one image for your vehicle.', 'warning');
            isValid = false;
        }
    }

    if (!isValid && errorMessages.length > 0) {
        const message = `Please fix the following issues: ${errorMessages.join(', ')}`;
        showAlert(message, 'warning');
        
        // Scroll to first invalid field
        const firstInvalidField = currentPane.querySelector('.is-invalid');
        if (firstInvalidField) {
            firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstInvalidField.focus();
        }
    } else if (!isValid) {
        showAlert('Please fill in all required fields before proceeding to the next step.', 'warning');
    } else {
        // Show success message for completed step
        showStepSuccess();
    }

    return isValid;
}

function showStepSuccess() {
    const stepTitles = {
        1: 'Basic Information',
        2: 'Engine & Performance',
        3: 'Ownership & History', 
        4: 'Insurance & Documentation',
        5: 'Features & Condition'
    };

    if (currentStep < 6) {
        showAlert(`âœ… ${stepTitles[currentStep]} completed successfully!`, 'success');
    }
}

function showAlert(message, type = 'info') {
    // Remove any existing alerts first
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => alert.remove());

    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-relative`;
    alertDiv.style.cssText = 'z-index: 9999; margin-bottom: 1rem; font-size: 1.1rem; font-weight: 500;';
    alertDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            ${message}
        </div>
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;

    const container = document.querySelector('.wizard-container');
    container.insertBefore(alertDiv, container.firstChild);

    // Auto-remove after 8 seconds for success, 10 seconds for errors
    const timeout = type === 'success' ? 8000 : 10000;
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, timeout);

    // Scroll to top to ensure alert is visible
    container.scrollTop = 0;
}

function updateVehicleSummary() {
    const form = document.getElementById('vehicleWizardForm');
    const formData = new FormData(form);
    const summary = document.getElementById('vehicleSummary');

    // Get selected images count
    let imageCount = 0;
    for(let i = 0; i < 6; i++) {
        if (uploadedImages[i]) {
            imageCount++;
        }
    }

    const summaryData = [
        { label: 'Vehicle Title', value: formData.get('title') || 'Not specified' },
        { label: 'Year', value: formData.get('year') || 'Not specified' },
        { label: 'Make & Model', value: `${formData.get('make') || ''} ${formData.get('model') || ''}`.trim() || 'Not specified' },
        { label: 'Category', value: formData.get('category') || 'Not specified' },
        { label: 'Price', value: formData.get('price') ? `â‚¹${parseInt(formData.get('price')).toLocaleString()}` : 'Not specified' },
        { label: 'Mileage', value: formData.get('mileage') ? `${parseInt(formData.get('mileage')).toLocaleString()} miles` : 'Not specified' },
        { label: 'Fuel Type', value: formData.get('fuel_type') || 'Not specified' },
        { label: 'Transmission', value: formData.get('transmission') || 'Not specified' },
        { label: 'Contact Person', value: formData.get('contact_name') || 'Not specified' },
        { label: 'Contact Phone', value: formData.get('contact_phone') || 'Not specified' },
        { label: 'Images', value: `${imageCount} image(s) selected` }
    ];

    summary.innerHTML = summaryData.map(item => 
        `<div class="summary-item">
            <strong>${item.label}:</strong>
            <span>${item.value}</span>
        </div>`
    ).join('');
}

// Image preview functionality for multiple slots
function triggerImageUpload(slotIndex) {
    document.getElementById(`image-input-${slotIndex}`).click();
}

function handleImageUpload(slotIndex, input) {
    const file = input.files[0];
    if (!file) return;

    const maxFileSize = 5 * 1024 * 1024; // 5MB
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];

    if (!allowedTypes.includes(file.type)) {
        showAlert('Invalid file type. Please upload JPG, PNG, or GIF.', 'warning');
        return;
    }
    if (file.size > maxFileSize) {
        showAlert('File size exceeds the 5MB limit.', 'warning');
        return;
    }

    uploadedImages[slotIndex - 1] = file; // Store the file

    const reader = new FileReader();
    reader.onload = function(e) {
        const previewImage = document.getElementById(`image-preview-${slotIndex}`);
        const removeBtn = document.querySelector(`#image-slot-${slotIndex} .image-remove-btn`);
        previewImage.src = e.target.result;
        previewImage.style.display = 'block';
        if(removeBtn) removeBtn.style.display = 'flex';

        // Hide slot content
        const slotContent = document.querySelector(`#image-slot-${slotIndex} .slot-content`);
        if (slotContent) slotContent.style.display = 'none';
    };
    reader.readAsDataURL(file);

    // Update the hidden input for form submission with all files
    updateHiddenFileInput();
}

function removeImage(slotIndex) {
    const currentImage = uploadedImages[slotIndex - 1];
    console.log(`Removing image from slot ${slotIndex}:`, currentImage);
    
    uploadedImages[slotIndex - 1] = null; // Clear the image from array

    const previewImage = document.getElementById(`image-preview-${slotIndex}`);
    const removeBtn = document.querySelector(`#image-slot-${slotIndex} .image-remove-btn`);
    const input = document.getElementById(`image-input-${slotIndex}`);

    if (previewImage) {
        previewImage.src = '';
        previewImage.style.display = 'none';
        previewImage.onerror = null; // Clear error handler
    }
    
    if (removeBtn) removeBtn.style.display = 'none';
    
    if (input) input.value = ''; // Clear the file input

    // Show slot content again
    const slotContent = document.querySelector(`#image-slot-${slotIndex} .slot-content`);
    if (slotContent) slotContent.style.display = 'flex';

    // Reset slot styling
    const uploadSlot = document.querySelector(`#image-slot-${slotIndex} .image-upload-slot`);
    if (uploadSlot) {
        uploadSlot.style.border = '2px dashed #007bff';
        uploadSlot.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
    }

    updateHiddenFileInput();
    
    // Show confirmation
    if (typeof currentImage === 'string') {
        showAlert('Existing image marked for removal. Save to apply changes.', 'info');
    } else {
        showAlert('Image removed from upload queue.', 'info');
    }
}

// Function to update the hidden file input with all selected files
function updateHiddenFileInput() {
    const actualInput = document.querySelector('input[name="images"]');
    if (!actualInput) {
        console.warn('Hidden images input not found');
        return;
    }

    const dataTransfer = new DataTransfer();

    uploadedImages.forEach((file, index) => {
        if (file instanceof File) {
            dataTransfer.items.add(file);
            console.log(`Added new file to slot ${index + 1}:`, file.name);
        } else if (typeof file === 'string' && file.length > 0) {
            console.log(`Existing image in slot ${index + 1}:`, file);
            // For existing images (strings), we don't add them to the file input
            // They are preserved on the server side during edit operations
        }
    });
    
    actualInput.files = dataTransfer.files;
    console.log(`Updated hidden input with ${dataTransfer.files.length} new files`);
}

// Submit vehicle form function
// Global variable to track if we're in edit mode
let isEditMode = false;
let editVehicleId = null;

function submitVehicleForm() {
    console.log('Save Vehicle button clicked!');

    const submitBtn = document.getElementById('submitBtn');
    if (!submitBtn) {
        console.error('Submit button not found');
        return;
    }

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving Vehicle...';

    // Validate all required fields first
    if (!validateAllSteps()) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Vehicle';
        return;
    }

    // Get form data
    const form = document.getElementById('vehicleWizardForm');
    if (!form) {
        console.error('Form not found');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Vehicle';
        return;
    }

    const formData = new FormData(form);

    // Ensure we have uploaded images in the form data
    updateHiddenFileInput();

    console.log('Form data prepared, submitting...');
    console.log('Number of images attached:', formData.getAll('images').length);
    console.log('Edit mode:', isEditMode, 'Vehicle ID:', editVehicleId);

    // Determine the endpoint based on whether we're editing or adding
    const endpoint = isEditMode && editVehicleId ? `/admin/edit_vehicle/${editVehicleId}` : '/admin/add_vehicle';
    const actionText = isEditMode ? 'updated' : 'saved';

    // Submit via fetch
    fetch(endpoint, {
        method: 'POST',
        body: formData,
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('Got response, status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json().then(data => ({
            status: response.status,
            data: data
        })).catch(parseError => {
            throw new Error('Invalid response format from server');
        });
    })
    .then(({status, data}) => {
        console.log('Response data:', data);

        if (status === 200 && data.success) {
            showAlert(`ðŸŽ‰ Vehicle ${actionText} successfully! Your listing is now live on the marketplace.`, 'success');
            clearSavedFormData(); // Clear auto-saved draft
            // Reset wizard and close modal after a delay
            setTimeout(() => {
                document.getElementById('vehicleWizard').querySelector('.btn-close').click();
                // Reload to show the updated vehicle in the table
                window.location.reload(); 
            }, 3000);
        } else if (status === 400 && data.errors) {
            // Show specific validation errors and go to relevant step
            let errorMessages = [];
            let firstErrorStep = null;

            for (const [field, error] of Object.entries(data.errors)) {
                errorMessages.push(`${field}: ${error}`);

                // Determine which step has the error
                const fieldElement = document.querySelector(`[name="${field}"]`);
                if (fieldElement) {
                    fieldElement.classList.add('is-invalid');
                    const feedback = fieldElement.nextElementSibling;
                    if(feedback && feedback.classList.contains('invalid-feedback')) {
                        feedback.textContent = error;
                        feedback.style.display = 'block';
                    }
                    if (!firstErrorStep) {
                        firstErrorStep = getStepForField(field);
                    }
                } else {
                    console.warn(`Element for field "${field}" not found.`);
                }
            }

            showAlert('Please fix these errors: ' + errorMessages.join(', '), 'warning');

            // Go to the step with the first error
            if (firstErrorStep && firstErrorStep !== currentStep) {
                currentStep = firstErrorStep;
                updateWizardDisplay();
            } else if (firstErrorStep && firstErrorStep === 6) {
                // If error is in images and we are already on step 6, just show alert
                showAlert('Please fix the image upload issues.', 'warning');
            }
        } else {
            throw new Error(data.message || 'Failed to save vehicle');
        }
    })
    .catch(error => {
        console.error('Save error:', error);
        const errorMessage = error.message || 'Failed to save vehicle';
        showAlert('âŒ Error saving vehicle: ' + errorMessage, 'danger');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Vehicle';
    });
}

function validateAllSteps() {
    let allValid = true;
    const originalCurrentStep = currentStep;

    // Temporarily set currentStep to each step to trigger validation logic
    for (let step = 1; step <= totalSteps; step++) {
        currentStep = step; 
        if (!validateCurrentStep()) {
            allValid = false;
            // Don't break here, continue to validate all steps for comprehensive error reporting
        }
    }
    
    // Reset currentStep to the original value
    currentStep = originalCurrentStep;
    
    // Check image requirements - more flexible for editing
    const hasNewFiles = uploadedImages.some(img => img instanceof File);
    const hasExistingImages = uploadedImages.some(img => typeof img === 'string' && img.length > 0);
    const totalImages = uploadedImages.filter(img => img !== null).length;
    
    console.log(`Image validation: ${hasNewFiles ? 'Has new files' : 'No new files'}, ${hasExistingImages ? 'Has existing images' : 'No existing images'}, Total: ${totalImages}`);
    
    if (totalImages === 0) {
        showAlert('Please upload at least one image for your vehicle.', 'warning');
        allValid = false;
        // Navigate to the images step
        currentStep = 6;
        updateWizardDisplay();
    }

    if (allValid) {
        console.log('All validation checks passed');
    } else {
        console.log('Validation failed - please review form fields and images');
    }

    return allValid;
}

function getStepForField(fieldName) {
    const stepMap = {
        'title': 1, 'category': 1, 'year': 1, 'make': 1, 'model': 1, 'price': 1, 'mileage': 1, 'description': 1,
        'fuel_type': 2, 'transmission': 2, 'engine_size': 2, 'horsepower': 2, 'fuel_economy': 2, 'drivetrain': 2,
        'number_of_owners': 3, 'previous_owner_name': 3, 'previous_owner_phone': 3, 'previous_owner_email': 3,
        'odometer_reading': 3, 'accident_history': 3, 'service_records': 3,
        'insurance_company': 4, 'insurance_policy_number': 4, 'insurance_expiry': 4, 'registration_number': 4, 'vin_number': 4,
        'exterior_color': 5, 'interior_color': 5, 'features': 5, 'condition_rating': 5, 'warranty_info': 5,
        'contact_name': 5, 'contact_phone': 5, 'contact_email': 5,
        'images': 6
    };
    return stepMap[fieldName] || 1;
}

// Add real-time validation
document.querySelectorAll('input, select, textarea').forEach(field => {
    // Input event for most fields
    if (field.tagName !== 'SELECT') {
        field.addEventListener('input', function() {
            // Clear existing validation state
            this.classList.remove('is-invalid');
            const feedback = this.nextElementSibling;
            if(feedback && feedback.classList.contains('invalid-feedback')) {
                feedback.style.display = 'none';
                feedback.textContent = ''; // Clear error messages
            }

            // Real-time validation for specific fields
            if (this.name === 'title' && this.value.trim().length > 0 && this.value.trim().length < 5) {
                this.classList.add('is-invalid');
                if(feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.textContent = 'Vehicle Title must be at least 5 characters long';
                    feedback.style.display = 'block';
                }
            }

            if (this.name === 'year' && this.value) {
                const year = parseInt(this.value);
                if (isNaN(year) || year < 1990 || year > 2025) {
                    this.classList.add('is-invalid');
                    if(feedback && feedback.classList.contains('invalid-feedback')) {
                        feedback.textContent = 'Year must be between 1990 and 2025';
                        feedback.style.display = 'block';
                    }
                }
            }

            if (this.name === 'price' && this.value) {
                const price = parseFloat(this.value);
                if (isNaN(price) || price <= 0) {
                    this.classList.add('is-invalid');
                    if(feedback && feedback.classList.contains('invalid-feedback')) {
                        feedback.textContent = 'Price must be greater than 0';
                        feedback.style.display = 'block';
                    }
                }
            }

            if (this.name === 'mileage' && this.value) {
                const mileage = parseInt(this.value);
                if (isNaN(mileage) || mileage < 0) {
                    this.classList.add('is-invalid');
                    if(feedback && feedback.classList.contains('invalid-feedback')) {
                        feedback.textContent = 'Mileage cannot be negative';
                        feedback.style.display = 'block';
                    }
                }
            }
        });
    }
    
    // Blur event for required fields and specific validations
    field.addEventListener('blur', function() {
        const requiredFields = ['title', 'category', 'make', 'model', 'year', 'price', 'mileage', 'contact_name', 'contact_phone'];
        const fieldName = this.name;
        const fieldValue = this.value;
        const feedback = this.nextElementSibling;

        // Clear existing state first
        this.classList.remove('is-invalid');
        if(feedback && feedback.classList.contains('invalid-feedback')) {
            feedback.style.display = 'none';
            feedback.textContent = '';
        }

        // Check if it's a required field and empty
        if (requiredFields.includes(fieldName) && (!fieldValue || !fieldValue.trim())) {
            this.classList.add('is-invalid');
            if(feedback && feedback.classList.contains('invalid-feedback')) {
                // Dynamically get label text for better feedback
                let labelText = '';
                const labelElement = document.querySelector(`label[for="${this.id}"]`);
                if (labelElement) {
                    labelText = labelElement.textContent.replace('*', '').trim();
                } else {
                    // Fallback if label is not found or not associated by 'for'
                    labelText = fieldName.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                }
                feedback.textContent = `${labelText} is required`;
                feedback.style.display = 'block';
            }
            return; // Exit if it's just an empty required field
        }

        // Perform specific validations on blur if field has a value
        if (fieldValue) {
            let fieldValid = true;
            let fieldError = '';

            if (fieldName === 'title' && fieldValue.trim().length < 5) {
                fieldValid = false;
                fieldError = 'Vehicle Title must be at least 5 characters long';
            } else if (fieldName === 'year') {
                const year = parseInt(fieldValue);
                if (isNaN(year) || year < 1990 || year > 2025) {
                    fieldValid = false;
                    fieldError = 'Year must be between 1990 and 2025';
                }
            } else if (fieldName === 'price') {
                const price = parseFloat(fieldValue);
                if (isNaN(price) || price <= 0) {
                    fieldValid = false;
                    fieldError = 'Price must be greater than 0';
                }
            } else if (fieldName === 'mileage') {
                const mileage = parseInt(fieldValue);
                if (isNaN(mileage) || mileage < 0) {
                    fieldValid = false;
                    fieldError = 'Mileage cannot be negative';
                }
            } else if (fieldName === 'contact_phone') {
                const phoneRegex = /^[\d\s\-\(\)\+\.]{10,}$/; // Basic validation for phone numbers
                if (!phoneRegex.test(fieldValue)) {
                    fieldValid = false;
                    fieldError = 'Please enter a valid phone number';
                }
            }

            if (!fieldValid) {
                this.classList.add('is-invalid');
                if(feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.textContent = fieldError;
                    feedback.style.display = 'block';
                }
            }
        }
    });
});


// Auto-populate title
function autoPopulateTitle() {
    const year = document.querySelector('[name=year]');
    const make = document.querySelector('[name=make]');
    const model = document.querySelector('[name=model]');
    const title = document.querySelector('[name=title]');

    if (year && make && model && title && !title.value.trim()) {
        title.value = `${year.value} ${make.value} ${model.value}`;
    }
}

document.querySelector('[name=year]').addEventListener('blur', autoPopulateTitle);
document.querySelector('[name=make]').addEventListener('blur', autoPopulateTitle);
document.querySelector('[name=model]').addEventListener('blur', autoPopulateTitle);

// Search functionality
document.getElementById('searchInput').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#vehiclesTable tbody tr');

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Initialize edit button handlers after page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, setting up button handlers...');
    
    // Set up edit button handlers
    document.addEventListener('click', function(e) {
        if (e.target.matches('button[onclick*="editVehicle"]') || e.target.closest('button[onclick*="editVehicle"]')) {
            e.preventDefault();
            const button = e.target.matches('button') ? e.target : e.target.closest('button');
            const onclickAttr = button.getAttribute('onclick');
            if (onclickAttr) {
                const match = onclickAttr.match(/editVehicle\('([^']+)'\)/);
                if (match) {
                    const vehicleId = match[1];
                    console.log('Edit button clicked for vehicle:', vehicleId);
                    window.editVehicle(vehicleId);
                }
            }
        }
    });
});

// Vehicle actions - define globally accessible functions
window.viewVehicle = function(id) {
    window.open(`/vehicle/${id}`, '_blank');
};

// Define editVehicle function globally
window.editVehicle = async function(id) {
    console.log(`Editing vehicle with ID: ${id}`);
    
    // Set edit mode
    isEditMode = true;
    editVehicleId = id;
    
    // Clear form first
    document.getElementById('vehicleWizardForm').reset();
    uploadedImages.fill(null);
    
    // Clear image previews
    for(let i = 1; i <= 6; i++) {
        const previewImage = document.getElementById(`image-preview-${i}`);
        const removeBtn = document.querySelector(`#image-slot-${i} .image-remove-btn`);
        const slotContent = document.querySelector(`#image-slot-${i} .slot-content`);
        
        if(previewImage) {
            previewImage.src = '';
            previewImage.style.display = 'none';
        }
        if(removeBtn) removeBtn.style.display = 'none';
        if(slotContent) slotContent.style.display = 'flex';
    }

    // Clear validation states
    document.querySelectorAll('.form-control, .form-select').forEach(field => {
        field.classList.remove('is-invalid', 'is-valid');
        const feedback = field.nextElementSibling;
        if(feedback && feedback.classList.contains('invalid-feedback')) {
            feedback.style.display = 'none';
            feedback.textContent = '';
        }
    });

    // Fetch vehicle data with comprehensive error handling
    try {
        const response = await fetch(`/admin/vehicle/${id}`, {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            }
        });

        console.log('Response status:', response.status);
        
        if (!response.ok) {
            if (response.status === 401) {
                throw new Error('Authentication required. Please log in again.');
            } else if (response.status === 404) {
                throw new Error('Vehicle not found.');
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        }

        const data = await response.json();
        console.log('Vehicle data received:', data);

        if (!data.success) {
            throw new Error(data.message || 'Failed to load vehicle data');
        }

        const editForm = document.getElementById('vehicleWizardForm');
        if (!editForm) {
            throw new Error("Vehicle form not found!");
        }

        // Populate form fields with proper null handling
        const vehicleData = data.vehicle || data;
        console.log('Populating form with data:', vehicleData);

        // Define fields that should not be populated (system fields)
        const excludeFields = ['id', 'created_at', 'updated_at'];

        for (const [key, value] of Object.entries(vehicleData)) {
            if (excludeFields.includes(key)) {
                console.log(`Skipping system field: ${key}`);
                continue;
            }

            const input = editForm.querySelector(`[name="${key}"]`);
            if (input) {
                console.log(`Setting ${key} to:`, value);
                
                // Handle different input types properly
                if (input.type === 'checkbox') {
                    input.checked = Boolean(value);
                } else if (input.tagName === 'SELECT') {
                    // Handle select dropdowns with proper validation
                    const valueToSet = value && value !== 'null' ? value.toString() : '';
                    const optionExists = Array.from(input.options).some(option => option.value === valueToSet);
                    
                    if (optionExists) {
                        input.value = valueToSet;
                    } else if (valueToSet === '') {
                        input.value = '';
                    } else {
                        console.warn(`Option "${valueToSet}" not found in select ${key}, setting to empty`);
                        input.value = '';
                    }
                    
                    // Trigger change event to update display
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                } else if (input.type === 'number') {
                    // Handle numbers with validation
                    const numValue = value !== null && value !== undefined && value !== 'null' ? Number(value) : '';
                    input.value = !isNaN(numValue) && numValue !== '' ? numValue : '';
                } else if (input.type === 'text' || input.type === 'email' || input.type === 'tel' || input.tagName === 'TEXTAREA') {
                    // Handle text fields with null safety
                    input.value = value !== null && value !== undefined && value !== 'null' ? value.toString() : '';
                } else {
                    // Default handling for other input types
                    input.value = value !== null && value !== undefined && value !== 'null' ? value.toString() : '';
                }
                
                // Clear any validation errors when populating
                input.classList.remove('is-invalid', 'is-valid');
                const feedback = input.nextElementSibling;
                if(feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.style.display = 'none';
                    feedback.textContent = '';
                }
            } else if (key !== 'images') {
                console.log(`No input found for field: ${key}`);
            }
        }

        // Special handling for images display with error checking
        if (vehicleData.images && Array.isArray(vehicleData.images)) {
            console.log(`Loading ${vehicleData.images.length} existing images`);
            
            vehicleData.images.forEach((imageName, index) => {
                if (imageName && index < 6) { // Ensure we don't exceed 6 slots
                    uploadedImages[index] = imageName; // Store as string for existing images

                    const previewImage = document.getElementById(`image-preview-${index + 1}`);
                    const removeBtn = document.querySelector(`#image-slot-${index + 1} .image-remove-btn`);
                    const slotContent = document.querySelector(`#image-slot-${index + 1} .slot-content`);

                    if(previewImage) {
                        previewImage.src = `/static/uploads/${imageName}`;
                        previewImage.style.display = 'block';
                        
                        // Add error handling for image loading
                        previewImage.onerror = function() {
                            console.warn(`Failed to load image: ${imageName}`);
                            this.style.display = 'none';
                            if (slotContent) slotContent.style.display = 'flex';
                            uploadedImages[index] = null; // Remove from array if failed to load
                        };
                    }
                    
                    if(removeBtn) removeBtn.style.display = 'flex';
                    if (slotContent) slotContent.style.display = 'none';
                }
            });
            updateHiddenFileInput(); // Update the hidden input
        } else {
            console.log('No images found for this vehicle');
        }

        // Update modal title for edit mode
        const modalTitle = document.getElementById('modalTitle');
        if (modalTitle) {
            modalTitle.innerHTML = '<i class="fas fa-edit me-2"></i>Edit Vehicle - Step by Step';
        }

        // Update current step to the first step for editing flow
        currentStep = 1;
        updateWizardDisplay(); // Refresh UI to show step 1 and correct progress

        // Show success message
        showAlert('Vehicle data loaded successfully for editing', 'success');

        // Make modal visible
        new bootstrap.Modal(document.getElementById('vehicleWizard')).show();
        
    } catch (error) {
        // Only log actual errors, not empty objects
        if (error && (error.message || error.toString() !== '[object Object]')) {
            console.error('Error fetching vehicle data:', error);
            const errorMessage = error.message || 'Failed to load vehicle data';
            showAlert('Error loading vehicle data: ' + errorMessage, 'danger');
            
            // Reset edit mode on error
            isEditMode = false;
            editVehicleId = null;
        }
    }
};

window.deleteVehicle = function(id) {
    if (confirm('Are you sure you want to delete this vehicle? This action cannot be undone.')) {
        // Handle deletion
        fetch(`/admin/delete_vehicle/${id}`, { 
            method: 'DELETE',
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Vehicle deleted successfully!');
                location.reload();
            } else {
                alert('Failed to delete vehicle: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error deleting vehicle:', error);
            const errorMessage = error.message || 'Failed to delete vehicle';
            alert('An error occurred while trying to delete the vehicle: ' + errorMessage);
        });
    }
}

// Test alert function
function testAlert() {
    showAlert('ðŸ”” This is a test notification! The alert system is working properly.', 'info');
}

// Add click handler when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, setting up button handlers...');

    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent default form submission if any
            submitVehicleForm();
        });
    } else {
        console.log('Submit button not found.');
    }

    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + Right Arrow = Next step
        if ((e.ctrlKey || e.metaKey) && e.key === 'ArrowRight' && currentStep < totalSteps && currentStep !== totalSteps) {
            e.preventDefault();
            changeStep(1);
        }
        // Ctrl/Cmd + Left Arrow = Previous step  
        if ((e.ctrlKey || e.metaKey) && e.key === 'ArrowLeft' && currentStep > 1) {
            e.preventDefault();
            changeStep(-1);
        }
        // Ctrl/Cmd + S = Save (on last step)
        if ((e.ctrlKey || e.metaKey) && e.key === 's' && currentStep === totalSteps) {
            e.preventDefault();
            submitVehicleForm();
        }
    });

    // Auto-save form data to localStorage
    setInterval(autoSaveFormData, 30000); // Save every 30 seconds

    // Load saved form data
    loadSavedFormData();
});

// Auto-save functionality
function autoSaveFormData() {
    // Only save if the wizard is open and the user has started filling the form
    const modalElement = document.getElementById('vehicleWizard');
    const isModalOpen = modalElement && modalElement.classList.contains('show');

    if (isModalOpen && (currentStep > 1 || Object.values(uploadedImages).some(img => img !== null))) { 
        const form = document.getElementById('vehicleWizardForm');
        if (form) {
            const formData = new FormData(form);
            const savedData = {};

            for (let [key, value] of formData.entries()) {
                if (value && key !== 'images') { // Exclude images for simple save
                    savedData[key] = value;
                }
            }

            // Save the count of uploaded images, not the files themselves
            savedData.imageCount = uploadedImages.filter(img => img !== null).length;
            savedData.currentStep = currentStep; // Save current step

            localStorage.setItem('automarket_vehicle_draft', JSON.stringify(savedData));
            console.log('Draft saved automatically.');
        }
    }
}

function loadSavedFormData() {
    const savedData = localStorage.getItem('automarket_vehicle_draft');
    if (savedData) {
        try {
            const data = JSON.parse(savedData);

            // Ask user if they want to restore
            if (confirm('Found a previously saved draft. Would you like to restore it?')) {
                Object.keys(data).forEach(key => {
                    if (key !== 'imageCount' && key !== 'currentStep') { // Avoid trying to set imageCount or currentStep as a field value
                        const field = document.querySelector(`[name="${key}"]`);
                        if (field) {
                            field.value = data[key];
                        }
                    }
                });

                // Restore image previews if count is > 0
                if (data.imageCount > 0) {
                    // This is a simplified restoration. A more robust solution would store image file references if possible.
                    // For now, we inform the user they need to re-upload.
                    showAlert(`Restored data from draft. Please re-upload images if needed.`, 'info');
                    // Update uploadedImages array based on count, though actual files aren't restored here.
                    for(let i = 0; i < data.imageCount; i++) {
                        if(i < uploadedImages.length) {
                            uploadedImages[i] = 'restored_placeholder'; // Indicate an image slot was used
                        }
                    }
                }

                // Update current step if draft data exists beyond the first step
                if (data.currentStep && parseInt(data.currentStep) > 1) {
                    currentStep = parseInt(data.currentStep);
                } else {
                    currentStep = 1; // Default to step 1 if no valid step data
                }
                updateWizardDisplay(); // Update UI based on restored data and step

                showAlert('âœ… Draft restored successfully!', 'success');
            } else {
                // If user declines, clear the draft
                clearSavedFormData();
            }
        } catch (e) {
            console.error('Error loading saved data:', e);
            // Optionally clear the corrupted data
            clearSavedFormData();
        }
    }
}

function clearSavedFormData() {
    localStorage.removeItem('automarket_vehicle_draft');
    console.log('Draft cleared.');
}
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Professional Admin Dashboard - AutoMarket{% endblock %}

{% block content %}
<style>
/* Professional styling for enhanced admin dashboard */
.dashboard-header {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border-radius: 12px;
    margin-bottom: 2rem;
}

.stats-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    border: none;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.stats-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
}

.vehicle-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.table th {
    background: #f8f9fa;
    border: none;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 0.5px;
    padding: 1rem 0.75rem;
}

.table td {
    border-color: #f1f3f4;
    padding: 1rem 0.75rem;
    vertical-align: middle;
}

.modal-header {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border-bottom: none;
}

.modal-header .btn-close {
    filter: invert(1);
}

.form-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border-left: 4px solid #007bff;
}

.form-section h6 {
    color: #007bff;
    font-weight: 600;
    margin-bottom: 1rem;
    text-transform: uppercase;
    font-size: 0.9rem;
    letter-spacing: 0.5px;
}

.form-control, .form-select {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
    color: #212529 !important;
    background-color: #ffffff !important;
}

.form-control:focus, .form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.15);
    color: #212529 !important;
    background-color: #ffffff !important;
}

.btn-action {
    border-radius: 6px;
    padding: 0.375rem 0.75rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-action:hover {
    transform: translateY(-1px);
}

.status-badge {
    font-weight: 500;
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
}

.image-preview {
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.loading-spinner {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

/* Global form field styling to ensure black text in all forms */
.modal .form-control,
.modal .form-select,
.modal textarea,
.modal input {
    color: #212529 !important;
    background-color: #ffffff !important;
    border: 2px solid #e9ecef !important;
}

.modal .form-control:focus,
.modal .form-select:focus,
.modal textarea:focus,
.modal input:focus {
    color: #212529 !important;
    background-color: #ffffff !important;
    border-color: #007bff !important;
}

.modal .form-label {
    color: #212529 !important;
    font-weight: 600 !important;
}

/* Image slot specific styles */
.image-upload-slot {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 150px; /* Fixed height for consistency */
    border: 2px dashed #007bff;
    border-radius: 8px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    cursor: pointer;
    transition: border-color 0.3s, background-color 0.3s;
    position: relative;
    overflow: hidden; /* To contain the image preview */
}

.image-upload-slot:hover {
    border-color: #0056b3;
}

.image-upload-slot input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.slot-content i {
    font-size: 2rem;
    color: #007bff;
    margin-bottom: 0.5rem;
}

.slot-content p {
    color: #6c757d;
    font-size: 0.9rem;
}

.image-preview-container {
    position: relative;
    width: 100%;
    height: 150px; /* Match slot height */
    border-radius: 8px;
    overflow: hidden;
    display: none; /* Hidden by default */
}

.image-preview-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.remove-image-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(0,0,0,0.5);
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
}
.remove-image-btn:hover {
    background: rgba(0,0,0,0.7);
}
</style>

<div class="container-fluid py-4">
    <!-- Dashboard Header -->
    <div class="dashboard-header p-4 mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-tachometer-alt me-2"></i>Professional Admin Dashboard
                </h1>
                <p class="mb-0 opacity-75">Manage your vehicle inventory with professional tools</p>
            </div>
            <div class="col-md-4 text-md-end">
                <button type="button" class="btn btn-light btn-lg" data-bs-toggle="modal" data-bs-target="#vehicleModal" onclick="openAddModal()">
                    <i class="fas fa-plus me-2"></i>Add New Vehicle
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <div class="stats-icon bg-primary text-white">
                        <i class="fas fa-car fa-lg"></i>
                    </div>
                    <h3 class="text-primary mb-1">{{ vehicles|length }}</h3>
                    <h6 class="text-muted mb-0">Total Vehicles</h6>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <div class="stats-icon bg-success text-white">
                        <i class="fas fa-check-circle fa-lg"></i>
                    </div>
                    <h3 class="text-success mb-1">{{ vehicles|selectattr("status", "equalto", "available")|list|length }}</h3>
                    <h6 class="text-muted mb-0">Available</h6>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <div class="stats-icon bg-warning text-white">
                        <i class="fas fa-handshake fa-lg"></i>
                    </div>
                    <h3 class="text-warning mb-1">{{ vehicles|selectattr("status", "equalto", "sold")|list|length }}</h3>
                    <h6 class="text-muted mb-0">Sold</h6>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <div class="stats-icon bg-info text-white">
                        <i class="fas fa-dollar-sign fa-lg"></i>
                    </div>
                    <h3 class="text-info mb-1">${{ "{:,.0f}".format((vehicles|selectattr("status", "equalto", "available")|map(attribute="price")|sum)/1000) }}K</h3>
                    <h6 class="text-muted mb-0">Total Inventory Value</h6>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-bolt me-2 text-primary"></i>Quick Actions
                    </h5>
                    <div class="btn-group flex-wrap" role="group">
                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#vehicleModal" onclick="openAddModal()">
                            <i class="fas fa-plus me-1"></i>Add Vehicle
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="exportData()">
                            <i class="fas fa-download me-1"></i>Export Data
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="generateReport()">
                            <i class="fas fa-chart-bar me-1"></i>Generate Report
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="bulkActions()">
                            <i class="fas fa-edit me-1"></i>Bulk Actions
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vehicles Table -->
    <div class="vehicle-table">
        <div class="card-header bg-white border-bottom">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2 text-primary"></i>Vehicle Inventory
                    </h5>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search vehicles..." id="searchInput">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover mb-0" id="vehiclesTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll"></th>
                        <th>Image</th>
                        <th>Vehicle Details</th>
                        <th>Price</th>
                        <th>Mileage</th>
                        <th>Status</th>
                        <th>Contact</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vehicle in vehicles %}
                    <tr data-vehicle-id="{{ vehicle.id }}">
                        <td>
                            <input type="checkbox" class="vehicle-checkbox" value="{{ vehicle.id }}">
                        </td>
                        <td>
                            {% if vehicle.images_list %}
                                <img src="{{ url_for('static', filename='uploads/' + vehicle.images_list[0]) }}"
                                     class="rounded" style="width: 60px; height: 45px; object-fit: cover;"
                                     alt="{{ vehicle.title }}">
                            {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center text-muted"
                                     style="width: 60px; height: 45px;">
                                    <i class="fas fa-car"></i>
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <div>
                                <h6 class="mb-1">{{ vehicle.title }}</h6>
                                <small class="text-muted">{{ vehicle.year }} â€¢ {{ vehicle.make }} {{ vehicle.model }}</small>
                                <br><span class="badge bg-light text-dark">{{ vehicle.category }}</span>
                            </div>
                        </td>
                        <td>
                            <strong class="text-success">${{ "{:,.0f}".format(vehicle.price) }}</strong>
                        </td>
                        <td>
                            {{ "{:,}".format(vehicle.mileage) }} mi
                        </td>
                        <td>
                            {% if vehicle.status == 'available' %}
                                <span class="badge bg-success status-badge">Available</span>
                            {% else %}
                                <span class="badge bg-secondary status-badge">Sold</span>
                            {% endif %}
                        </td>
                        <td>
                            <div>
                                <small class="d-block">{{ vehicle.contact_name }}</small>
                                <small class="text-muted">{{ vehicle.contact_phone }}</small>
                            </div>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary btn-action"
                                        onclick="viewVehicle('{{ vehicle.id }}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-action"
                                        onclick="editVehicle('{{ vehicle.id }}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-action"
                                        onclick="confirmDelete('{{ vehicle.id }}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Enhanced Vehicle Modal with Professional Forms -->
<div class="modal fade" id="vehicleModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-car me-2"></i>
                    <span id="modalTitle">Add New Vehicle</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="vehicleForm" method="POST" enctype="multipart/form-data">

                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">

                    <!-- Basic Information Section -->
                    <div class="form-section">
                        <h6><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                        <div class="row g-3">
                            <div class="col-md-8">
                                {{ form.title.label(class="form-label", style="color: #212529; font-weight: 600;") }}
                                {{ form.title(class="form-control", placeholder="e.g., 2020 Honda Civic LX", style="color: #212529 !important; background-color: #ffffff !important;") }}
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-4">
                                {{ form.category.label(class="form-label", style="color: #212529; font-weight: 600;") }}
                                {{ form.category(class="form-select", style="color: #212529 !important; background-color: #ffffff !important;") }}
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-4">
                                {{ form.make.label(class="form-label", style="color: #212529; font-weight: 600;") }}
                                {{ form.make(class="form-control", placeholder="e.g., Honda", style="color: #212529 !important; background-color: #ffffff !important;") }}
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-4">
                                {{ form.model.label(class="form-label", style="color: #212529; font-weight: 600;") }}
                                {{ form.model(class="form-control", placeholder="e.g., Civic", style="color: #212529 !important; background-color: #ffffff !important;") }}
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-4">
                                {{ form.year.label(class="form-label", style="color: #212529; font-weight: 600;") }}
                                {{ form.year(class="form-control", placeholder="e.g., 2020", style="color: #212529 !important; background-color: #ffffff !important;") }}
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-6">
                                {{ form.price.label(class="form-label") }}
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form.price(class="form-control", placeholder="25000") }}
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-6">
                                {{ form.mileage.label(class="form-label") }}
                                <div class="input-group">
                                    {{ form.mileage(class="form-control", placeholder="50000") }}
                                    <span class="input-group-text">miles</span>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-12">
                                {{ form.description.label(class="form-label") }}
                                {{ form.description(class="form-control", rows="3", placeholder="Describe the vehicle's condition, features, and any important details...") }}
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-6">
                                {{ form.status.label(class="form-label") }}
                                {{ form.status(class="form-select") }}
                            </div>
                        </div>
                    </div>

                    <!-- Engine & Performance Section -->
                    <div class="form-section">
                        <h6><i class="fas fa-cogs me-2"></i>Engine & Performance</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                {{ form.fuel_type.label(class="form-label") }}
                                {{ form.fuel_type(class="form-select") }}
                            </div>
                            <div class="col-md-6">
                                {{ form.transmission.label(class="form-label") }}
                                {{ form.transmission(class="form-select") }}
                            </div>
                            <div class="col-md-4">
                                {{ form.engine_size.label(class="form-label") }}
                                {{ form.engine_size(class="form-control", placeholder="e.g., 2.0L") }}
                            </div>
                            <div class="col-md-4">
                                {{ form.horsepower.label(class="form-label") }}
                                {{ form.horsepower(class="form-control", placeholder="e.g., 180") }}
                            </div>
                            <div class="col-md-4">
                                {{ form.drivetrain.label(class="form-label") }}
                                {{ form.drivetrain(class="form-select") }}
                            </div>
                            <div class="col-md-6">
                                {{ form.fuel_economy.label(class="form-label") }}
                                {{ form.fuel_economy(class="form-control", placeholder="e.g., 25 city / 32 highway mpg") }}
                            </div>
                        </div>
                    </div>

                    <!-- Ownership & History Section -->
                    <div class="form-section">
                        <h6><i class="fas fa-history me-2"></i>Ownership & History</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                {{ form.number_of_owners.label(class="form-label") }}
                                {{ form.number_of_owners(class="form-control", placeholder="e.g., 1") }}
                            </div>
                            <div class="col-md-6">
                                {{ form.odometer_reading.label(class="form-label") }}
                                {{ form.odometer_reading(class="form-control", placeholder="Current odometer reading") }}
                            </div>
                            <div class="col-md-4">
                                {{ form.previous_owner_name.label(class="form-label") }}
                                {{ form.previous_owner_name(class="form-control", placeholder="Previous owner name") }}
                            </div>
                            <div class="col-md-4">
                                {{ form.previous_owner_phone.label(class="form-label") }}
                                {{ form.previous_owner_phone(class="form-control", placeholder="(555) 123-4567") }}
                            </div>
                            <div class="col-md-4">
                                {{ form.previous_owner_email.label(class="form-label") }}
                                {{ form.previous_owner_email(class="form-control", placeholder="owner@email.com") }}
                            </div>
                            <div class="col-md-6">
                                {{ form.accident_history.label(class="form-label") }}
                                {{ form.accident_history(class="form-control", rows="2", placeholder="Any accident history or damage reports...") }}
                            </div>
                            <div class="col-md-6">
                                {{ form.service_records.label(class="form-label") }}
                                {{ form.service_records(class="form-control", rows="2", placeholder="Maintenance and service records...") }}
                            </div>
                        </div>
                    </div>

                    <!-- Insurance & Documentation Section -->
                    <div class="form-section">
                        <h6><i class="fas fa-shield-alt me-2"></i>Insurance & Documentation</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                {{ form.insurance_company.label(class="form-label") }}
                                {{ form.insurance_company(class="form-control", placeholder="e.g., State Farm") }}
                            </div>
                            <div class="col-md-4">
                                {{ form.insurance_policy_number.label(class="form-label") }}
                                {{ form.insurance_policy_number(class="form-control", placeholder="Policy number") }}
                            </div>
                            <div class="col-md-4">
                                {{ form.insurance_expiry.label(class="form-label") }}
                                {{ form.insurance_expiry(class="form-control", placeholder="MM/DD/YYYY") }}
                            </div>
                            <div class="col-md-6">
                                {{ form.registration_number.label(class="form-label") }}
                                {{ form.registration_number(class="form-control", placeholder="Registration number") }}
                            </div>
                            <div class="col-md-6">
                                {{ form.vin_number.label(class="form-label") }}
                                {{ form.vin_number(class="form-control", placeholder="17-character VIN", maxlength="17") }}
                            </div>
                        </div>
                    </div>

                    <!-- Features & Condition Section -->
                    <div class="form-section">
                        <h6><i class="fas fa-star me-2"></i>Features & Condition</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                {{ form.exterior_color.label(class="form-label") }}
                                {{ form.exterior_color(class="form-control", placeholder="e.g., Blue") }}
                            </div>
                            <div class="col-md-4">
                                {{ form.interior_color.label(class="form-label") }}
                                {{ form.interior_color(class="form-control", placeholder="e.g., Black") }}
                            </div>
                            <div class="col-md-4">
                                {{ form.condition_rating.label(class="form-label") }}
                                {{ form.condition_rating(class="form-select") }}
                            </div>
                            <div class="col-md-6">
                                {{ form.features.label(class="form-label") }}
                                {{ form.features(class="form-control", rows="2", placeholder="List features separated by commas (e.g., Sunroof, Leather seats, Navigation...)") }}
                            </div>
                            <div class="col-md-6">
                                {{ form.warranty_info.label(class="form-label") }}
                                {{ form.warranty_info(class="form-control", rows="2", placeholder="Warranty information and coverage details...") }}
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information Section -->
                    <div class="form-section">
                        <h6><i class="fas fa-address-book me-2"></i>Contact Information</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                {{ form.contact_name.label(class="form-label") }}
                                {{ form.contact_name(class="form-control", placeholder="Contact person name") }}
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-4">
                                {{ form.contact_phone.label(class="form-label") }}
                                {{ form.contact_phone(class="form-control", placeholder="(555) 123-4567") }}
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-4">
                                {{ form.contact_email.label(class="form-label") }}
                                {{ form.contact_email(class="form-control", placeholder="contact@email.com") }}
                            </div>
                        </div>
                    </div>

                    <!-- Images Section -->
                    <div class="form-section">
                        <h6><i class="fas fa-images me-2"></i>Vehicle Images</h6>
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="row g-3" id="image-slots-container">
                                    {% for i in range(1, 7) %}
                                    <div class="col-md-2 mb-3">
                                        <div class="image-upload-slot" id="image-slot-{{ i }}">
                                            <input type="file" id="image-input-{{ i }}" name="image-{{ i }}" accept="image/*" onchange="previewImage({{ i }})">
                                            <div class="slot-content text-center">
                                                <i class="fas fa-camera"></i>
                                                <p>Slot {{ i }}</p>
                                            </div>
                                            <div class="image-preview-container" id="image-preview-container-{{ i }}">
                                                <img id="image-preview-{{ i }}" src="" alt="Image Preview">
                                                <button type="button" class="remove-image-btn" onclick="removeImage({{ i }})">&times;</button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="form-text mt-2">Select up to 6 high-quality images. Accepted formats: JPG, PNG, GIF (Max 16MB each)</div>
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-12" id="current-images-container"></div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-save me-1"></i>
                        <span id="submitText">Save Vehicle</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mb-0">Processing...</p>
    </div>
</div>

<script>
// Enhanced admin dashboard functionality
let currentVehicleId = null;
let uploadedImages = []; // Array to keep track of uploaded files for the current form submission

function showLoading() {
    document.getElementById('loading-overlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}

function openAddModal() {
    currentVehicleId = null;
    document.getElementById('modalTitle').textContent = 'Add New Vehicle';
    document.getElementById('submitText').textContent = 'Save Vehicle';
    document.getElementById('vehicleForm').reset();
    document.getElementById('vehicleForm').action = '/admin/add_vehicle';

    // Clear validation states
    document.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
        el.classList.remove('is-valid', 'is-invalid');
        const feedback = el.parentNode.querySelector('.invalid-feedback');
        if (feedback) feedback.textContent = '';
    });

    // Clear image slots
    clearAllImageSlots();
    document.getElementById('current-images-container').innerHTML = '';
}

function editVehicle(vehicleId) {
    currentVehicleId = vehicleId;
    document.getElementById('modalTitle').textContent = 'Edit Vehicle';
    document.getElementById('submitText').textContent = 'Update Vehicle';
    document.getElementById('vehicleForm').action = `/admin/edit_vehicle/${vehicleId}`;

    showLoading();

    // Fetch vehicle data
    fetch(`/admin/vehicle/${vehicleId}`)
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Vehicle data received:', data);
            if (data.success === false) {
                throw new Error(data.message || 'Failed to load vehicle data');
            }

            // Ensure we have valid vehicle data
            if (!data || typeof data !== 'object') {
                throw new Error('Invalid vehicle data received');
            }

            // Clear existing slots before populating
            clearAllImageSlots();
            document.getElementById('current-images-container').innerHTML = '';

            populateForm(data);
            hideLoading();

            // Ensure modal element exists before showing
            const modalElement = document.getElementById('vehicleModal');
            if (modalElement) {
                new bootstrap.Modal(modalElement).show();
            } else {
                throw new Error('Vehicle modal not found');
            }
        })
        .catch(error => {
            console.error('Error loading vehicle data:', error);
            hideLoading();
            showToast(`Error loading vehicle data: ${error.message || 'Unknown error'}`, 'danger');
        });
}

function populateForm(vehicle) {
    console.log('Populating form with vehicle data:', vehicle);

    // Clear previous validation states
    document.querySelectorAll('.is-invalid').forEach(el => {
        el.classList.remove('is-invalid');
        const feedback = el.parentNode.querySelector('.invalid-feedback');
        if (feedback) feedback.textContent = '';
    });

    // Populate all form fields with proper error handling
    Object.keys(vehicle).forEach(key => {
        try {
            // Skip certain keys that don't correspond to form fields or are handled separately
            if (['created_at', 'updated_at', 'images'].includes(key)) {
                return;
            }

            // Find the element by ID or name, prioritizing ID
            let field = document.getElementById(key);
            if (!field) {
                field = document.querySelector(`[name="${key}"]`);
            }

            if (field && vehicle[key] !== null && vehicle[key] !== undefined) {
                // Handle specific field types if necessary (e.g., select, checkboxes)
                field.value = vehicle[key];
            }
        } catch (error) {
            console.warn(`Error setting field ${key}:`, error);
        }
    });

    // Handle images display
    if (vehicle.images && Array.isArray(vehicle.images) && vehicle.images.length > 0) {
        displayCurrentImages(vehicle.images);
    } else if (vehicle.images && typeof vehicle.images === 'string' && vehicle.images.trim() !== '') {
        // Handle comma-separated string format if the backend sends it this way
        const imageArray = vehicle.images.split(',').map(img => img.trim()).filter(img => img !== '');
        if (imageArray.length > 0) {
            displayCurrentImages(imageArray);
        }
    }
}

function displayCurrentImages(images) {
    const container = document.getElementById('current-images-container');
    if (!container) return;

    container.innerHTML = '<h6 class="text-primary mb-3">Current Images</h6>';
    const imageRow = document.createElement('div');
    imageRow.className = 'row g-2 mb-3';

    images.forEach((image, index) => {
        const col = document.createElement('div');
        col.className = 'col-md-2'; // Adjust column size as needed

        const slotNumber = index + 1; // Assuming images array is ordered by slot

        // Find the corresponding image slot
        const slotElement = document.getElementById(`image-slot-${slotNumber}`);
        if (!slotElement) {
            console.warn(`Image slot ${slotNumber} not found for image ${image}`);
            return; // Skip if slot doesn't exist
        }

        // Update the slot with the image preview and remove button
        const previewContainer = slotElement.querySelector('.image-preview-container');
        const previewImage = previewContainer.querySelector('img');
        const removeBtn = previewContainer.querySelector('.remove-image-btn');
        const slotContent = slotElement.querySelector('.slot-content');
        const uploadInput = document.getElementById(`image-input-${slotNumber}`);

        if (previewContainer && previewImage && slotContent && uploadInput) {
            previewImage.src = `/static/uploads/${image}`;
            previewContainer.style.display = 'block'; // Show the preview container
            slotContent.style.display = 'none'; // Hide the default slot content
            slotElement.setAttribute('data-existing-image', image); // Mark as existing image
            uploadInput.value = ''; // Clear any selected file from the input

            // Add a remove button specifically for this existing image
            if (!removeBtn) {
                const newRemoveBtn = document.createElement('button');
                newRemoveBtn.type = 'button';
                newRemoveBtn.className = 'remove-image-btn';
                newRemoveBtn.innerHTML = '&times;';
                newRemoveBtn.onclick = () => removeExistingImage(slotNumber, image);
                previewContainer.appendChild(newRemoveBtn);
            }

            // Update the styled upload slot to indicate it has an image
            const uploadSlot = slotElement.querySelector('.image-upload-slot');
            if (uploadSlot) {
                uploadSlot.style.border = '1px solid #ced4da'; // Border for existing image
                uploadSlot.style.background = 'none'; // No gradient for existing image
            }
        }

        // Keep track of existing images for form submission
        uploadedImages[slotNumber - 1] = image; // Store the filename
    });
    updateFormFileInput(); // Update the hidden input with current image list
}


// Function to preview the selected image in its slot
function previewImage(slotNumber) {
    const input = document.getElementById(`image-input-${slotNumber}`);
    const previewContainer = document.getElementById(`image-preview-container-${slotNumber}`);
    const previewImage = document.getElementById(`image-preview-${slotNumber}`);
    const slotContent = document.getElementById(`image-slot-${slotNumber}`).querySelector('.slot-content');
    const uploadSlot = document.getElementById(`image-slot-${slotNumber}`).querySelector('.image-upload-slot');


    if (input.files && input.files[0]) {
        const file = input.files[0];
        if (file.size > 16 * 1024 * 1024) { // 16MB limit
            showToast('File size exceeds 16MB limit.', 'danger');
            input.value = ''; // Clear the input
            return;
        }

        const reader = new FileReader();

        reader.onload = function(e) {
            previewImage.src = e.target.result;
            previewContainer.style.display = 'block'; // Show preview container
            slotContent.style.display = 'none'; // Hide default content

            // Add remove button if it doesn't exist
            let removeBtn = previewContainer.querySelector('.remove-image-btn');
            if (!removeBtn) {
                removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-image-btn';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = () => removeImage(slotNumber);
                previewContainer.appendChild(removeBtn);
            }

            // Update slot styling
            if (uploadSlot) {
                uploadSlot.style.border = '1px solid #ced4da'; // Border for a filled slot
                uploadSlot.style.background = 'none';
            }

            // Store the file in the uploadedImages array
            uploadedImages[slotNumber - 1] = file;
            updateFormFileInput();
        }
        reader.readAsDataURL(file);
    } else {
        // If file input is cleared, reset the slot
        removeImage(slotNumber);
    }
}

function removeImage(slotNumber) {
    const slot = document.getElementById(`image-slot-${slotNumber}`);
    const previewContainer = document.getElementById(`image-preview-container-${slotNumber}`);
    const preview = document.getElementById(`image-preview-${slotNumber}`);
    const slotContent = slot?.querySelector('.slot-content');
    const removeBtn = previewContainer?.querySelector('.remove-image-btn');
    const input = document.getElementById(`image-input-${slotNumber}`);
    const uploadSlot = slot?.querySelector('.image-upload-slot');

    // Reset the slot
    if (previewContainer) previewContainer.style.display = 'none';
    if (preview) {
        preview.src = '';
    }
    if (slotContent) slotContent.style.display = 'block';
    if (input) input.value = '';
    if (removeBtn) removeBtn.remove();
    if (slot) slot.removeAttribute('data-existing-image'); // Clear existing image attribute

    // Reset slot styling
    if (uploadSlot) {
        uploadSlot.style.border = '2px dashed #007bff';
        uploadSlot.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
    }

    // Update uploaded images array
    uploadedImages[slotNumber - 1] = null;
    updateFormFileInput();
}

function removeExistingImage(slotNumber, imageName) {
    // Remove the visual representation
    removeImage(slotNumber);

    // Mark this image for deletion by setting its slot to null in uploadedImages
    // The backend logic will need to handle deleting images marked as null in their respective slots
    console.log(`Existing image ${imageName} marked for removal from slot ${slotNumber}`);
}

function clearAllImageSlots() {
    for (let i = 1; i <= 6; i++) {
        try {
            const slot = document.getElementById(`image-slot-${i}`);
            const previewContainer = document.getElementById(`image-preview-container-${i}`);
            const preview = document.getElementById(`image-preview-${i}`);
            const slotContent = slot?.querySelector('.slot-content');
            const removeBtn = previewContainer?.querySelector('.remove-image-btn');
            const input = document.getElementById(`image-input-${i}`);
            const uploadSlot = slot?.querySelector('.image-upload-slot');

            if (previewContainer) previewContainer.style.display = 'none';
            if (preview) {
                preview.src = '';
            }
            if (slotContent) slotContent.style.display = 'block';
            if (input) input.value = '';
            if (removeBtn) removeBtn.remove();
            if (slot) slot.removeAttribute('data-existing-image');
            if (uploadSlot) {
                uploadSlot.style.border = '2px dashed #007bff';
                uploadSlot.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
            }
        } catch (error) {
            console.warn(`Error clearing image slot ${i}:`, error);
        }
    }
    uploadedImages = []; // Reset the array
    updateFormFileInput();
}

// Helper function to update a hidden input field with the list of images to be submitted
// This is useful if the backend expects a consolidated list of files or image identifiers
function updateFormFileInput() {
    const formData = new FormData(document.getElementById('vehicleForm'));
    // You might want to append a field named 'images_to_submit' or similar
    // For now, let's assume files are directly appended via their inputs.
    // If you need to send existing image names and new files, you'll need a more complex approach.
    // For example, an array of objects: [{ slot: 1, file: File, existing: null }, { slot: 2, file: null, existing: 'image1.jpg' }]
    // Or separate fields for new uploads and fields to delete.

    // For simplicity in this example, we rely on the input[type=file] to carry the new files.
    // If removing existing images needs to be explicitly sent, you'd add a hidden input here.
}

function showToast(message, type) {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);

    setTimeout(() => {
        if (toast && toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 5000);
}

function confirmDelete(vehicleId) {
    if (confirm('Are you sure you want to delete this vehicle? This action cannot be undone.')) {
        deleteVehicle(vehicleId);
    }
}

function deleteVehicle(vehicleId) {
    showLoading();

    fetch(`/admin/delete_vehicle/${vehicleId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showToast(data.message || 'Vehicle deleted successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('Error deleting vehicle: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showToast('Error deleting vehicle', 'danger');
        console.error('Error:', error);
    });
}

function viewVehicle(vehicleId) {
    window.open(`/vehicle/${vehicleId}`, '_blank');
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#vehiclesTable tbody tr');

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Select all checkbox
document.getElementById('selectAll').addEventListener('change', function(e) {
    const checkboxes = document.querySelectorAll('.vehicle-checkbox');
    checkboxes.forEach(cb => cb.checked = e.target.checked);
});

// Quick actions
function exportData() {
    window.location.href = '/admin/export';
}

function generateReport() {
    alert('Report generation feature coming soon!');
}

function bulkActions() {
    const selected = document.querySelectorAll('.vehicle-checkbox:checked');
    if (selected.length === 0) {
        alert('Please select vehicles first');
        return;
    }
    alert(`Bulk actions for ${selected.length} vehicles - feature coming soon!`);
}

// Form submission handler
document.getElementById('vehicleForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

    // Prepare form data
    const formData = new FormData(this);

    // Add existing image information if we are editing
    // If an image slot has 'data-existing-image', we need to send that information.
    // The backend will then know which images to keep or delete.
    if (currentVehicleId) {
        for (let i = 1; i <= 6; i++) {
            const slot = document.getElementById(`image-slot-${i}`);
            const existingImageName = slot.getAttribute('data-existing-image');

            if (existingImageName) {
                // If the slot was modified (new file uploaded or removed), the name might be null/empty from uploadedImages
                // We need to differentiate between existing and new.
                const fileInput = document.getElementById(`image-input-${i}`);
                if (fileInput.files.length === 0) { // If no new file was uploaded to this slot
                    if (existingImageName) { // And there was an existing image
                        // Mark that this existing image should be kept if not explicitly removed
                        // Or, if it was removed (removeExistingImage called), then uploadedImages[i-1] will be null
                        if (uploadedImages[i-1] === null) { // Means removeExistingImage was called
                            formData.append(`remove_image_${i}`, 'true');
                        } else {
                            // This existing image is being kept. No explicit action needed for the backend to keep it,
                            // unless we need to explicitly tell the backend to associate it with the vehicle again.
                            // A common pattern is to send the names of existing images that remain.
                            formData.append(`existing_images`, existingImageName);
                        }
                    }
                }
            }
        }
    }

    const url = currentVehicleId ? `/admin/edit_vehicle/${currentVehicleId}` : '/admin/add_vehicle';

    fetch(url, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Vehicle saved successfully!', 'success');
            // Use Bootstrap's modal instance to hide the modal
            const modalElement = document.getElementById('vehicleModal');
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) {
                modalInstance.hide();
            }
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showToast(data.message || 'Error saving vehicle', 'danger');
            // Handle validation errors
            if (data.errors) {
                Object.keys(data.errors).forEach(field => {
                    const fieldElement = document.querySelector(`[name="${field}"]`);
                    if (fieldElement) {
                        fieldElement.classList.add('is-invalid');
                        const feedback = fieldElement.parentNode.querySelector('.invalid-feedback');
                        if (feedback) feedback.textContent = data.errors[field];
                    } else {
                        // Handle potential errors for fields not directly in the form, like image uploads
                        if (field.startsWith('image')) {
                            const imageErrorContainer = document.querySelector('.form-text + .invalid-feedback'); // Find the feedback div after form-text
                            if (imageErrorContainer) {
                                imageErrorContainer.textContent = data.errors[field];
                                imageErrorContainer.style.display = 'block';
                            }
                        }
                    }
                });
            }
        }
    })
    .catch(error => {
        showToast('Network error occurred', 'danger');
        console.error('Error:', error);
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
});
</script>
{% endblock %}